<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿…æ®ºï¼TÃ¢i-LÃ´ KuÃ­ (å¼µå¤©å¸«ç‰ˆ)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            user-select: none;
        }
        #gameCanvas {
            display: block;
            background: transparent;
        }
        /* UI å±¤ */
        #uiLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            color: #fff;
            font-size: 24px;
            text-shadow: 2px 2px 0 #000;
            width: 100%;
            box-sizing: border-box;
        }
        .hud-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .hud-bottom {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start; 
            padding-bottom: 20px;
            padding-left: 180px; 
            position: relative;
            pointer-events: auto;
        }
        .bar-container {
            width: 300px;
            height: 30px;
            background: #444; 
            border: 3px solid #D4AF37; 
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        .hp-bar-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #D4AF37);
            transition: width 0.2s;
        }
        .bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            white-space: nowrap;
        }
        
        /* çœŸå¯¦è¼¸å…¥æ¡†æ¨£å¼ */
        #gameTextInput {
            background: rgba(0, 0, 0, 0.8);
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 20px; 
            padding: 5px 15px;
            border: 3px solid #00FF00;
            border-radius: 10px;
            width: 250px; 
            max-width: 100%;
            text-align: center;
            margin-bottom: 5px;
            outline: none;
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
            transition: border-color 0.2s;
        }
        #gameTextInput::placeholder {
            color: rgba(0, 255, 0, 0.4);
            font-size: 14px;
        }
        
        /* é“å…·æ¬„ */
        .item-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 15px;
            border: 1px solid #555;
            pointer-events: auto;
            align-self: flex-start;
            margin-left: 10px;
        }
        .item-slot {
            width: 50px;
            height: 50px;
            background: #444;
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: 0.3s;
            position: relative;
            cursor: pointer;
        }
        .item-slot:active {
            transform: scale(0.95);
        }
        .item-slot.active {
            opacity: 1;
            border-color: #FFD700;
            box-shadow: 0 0 10px #FFD700;
            background: #554400;
            transform: scale(1.05);
        }
        .item-slot.active:hover {
            background: #665500;
        }
        /* item-icon é€šç”¨æ¨£å¼ */
        .item-icon { font-size: 20px; margin-bottom: 0px; }
        svg.item-icon-svg { margin-bottom: 2px; filter: drop-shadow(0px 0px 2px rgba(0,0,0,0.5)); overflow: visible; }
        .item-name { font-size: 10px; color: #ccc; font-weight: bold; }
        .item-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF0000;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* å·¦å´æ§åˆ¶å€ */
        .left-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
            z-index: 50;
            align-items: center;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #aaa;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #fff;
            transform: scale(1.1);
        }
        .control-btn.active {
            border-color: #00FF00;
            color: #00FF00;
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px #00FF00;
        }

        /* ç©å®¶é¡¯ç¤º */
        #playerNameDisplay {
            color: #FFD700;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            text-align: center;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* å…¨è¢å¹•é¸å–® */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex; flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 60;
        }
        .hidden { display: none !important; }
        
        #screen-paused { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }

        h1 {
            color: #FFD700; font-size: 50px; margin-bottom: 20px;
            text-shadow: 0 0 10px #FF4500;
            cursor: pointer; border: 4px solid #FFD700;
            padding: 15px 30px; border-radius: 10px;
            background: rgba(139, 0, 0, 0.5);
        }
        h1:hover { transform: scale(1.05); transition: 0.2s; }
        h2 { color: #fff; margin-bottom: 20px; font-size: 32px; }
        
        .form-group { margin: 15px 0; text-align: center; }
        input[type="text"]#nameInput {
            padding: 10px; font-size: 24px; border-radius: 5px;
            border: 2px solid #ccc; text-align: center; width: 300px;
            background: #fff; color: #000;
        }
        .btn-group { display: flex; gap: 20px; margin-top: 20px; }
        .btn {
            padding: 12px 25px; font-size: 20px;
            background: #FF4500; color: white;
            border: 2px solid #fff; border-radius: 10px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { background: #ff6600; transform: translateY(-3px); }
        .btn.selected {
            background: #FFD700; color: #000;
            border-color: #FF4500; box-shadow: 0 0 15px #FFD700;
        }
        .difficulty-btn { background: #333; border: 2px solid #888; }

        /* ç¬¦ä»¤æ¨£å¼ */
        .talisman-container { display: flex; gap: 60px; margin-top: 20px; }
        .talisman-card {
            width: 140px; height: 320px; position: relative; background-color: #FDD835;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: transform 0.3s;
            overflow: hidden; display: flex; flex-direction: column; align-items: center;
        }
        .talisman-card:hover { transform: translateY(-10px) scale(1.05); z-index: 10; box-shadow: 0 15px 30px rgba(255, 215, 0, 0.3); }
        .talisman-header-svg { width: 100%; height: 140px; margin-top: 10px; }
        .talisman-path { fill: none; stroke: #01579B; stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; }
        
        .analysis-box {
            background: rgba(30, 30, 20, 0.95); border: 2px solid #D4AF37; padding: 20px;
            border-radius: 10px; max-width: 600px; width: 90%; margin-top: 20px; text-align: left;
            color: #eee; font-size: 16px; line-height: 1.6; min-height: 120px; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        .analysis-title {
            color: #FFD700; font-weight: bold; margin-bottom: 10px; font-size: 20px;
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #555; padding-bottom: 5px;
        }
        .rank-badge {
            font-size: 24px; font-weight: bold; padding: 5px 25px; border-radius: 30px;
            background: #222; border: 2px solid #FFD700; color: #FFD700;
            margin-bottom: 15px; display: inline-block; box-shadow: 0 0 10px #FFD700;
        }
        .footer-credit {
            margin-top: 30px; color: #888; font-size: 16px; font-family: 'Courier New', monospace; text-shadow: 1px 1px 2px #000;
        }

        /* éŠæˆ²èªªæ˜è¦–çª— */
        .instruction-panel {
            background: rgba(20, 20, 30, 0.95); border: 2px solid #4FC3F7; border-radius: 15px;
            padding: 30px; max-width: 800px; width: 90%; text-align: left; color: white;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3); max-height: 85vh; overflow-y: auto; box-sizing: border-box;
        }
        .instruction-title {
            text-align: center; color: #4FC3F7; font-size: 36px; margin-bottom: 20px; font-weight: bold;
            border-bottom: 1px solid #555; padding-bottom: 15px;
        }
        .instruction-section { margin-bottom: 20px; }
        .instruction-section h3 { color: #FFD700; margin-bottom: 10px; font-size: 22px; }
        .instruction-section p, .instruction-section li { font-size: 18px; line-height: 1.6; color: #ddd; }
        .item-desc { display: flex; align-items: center; margin-bottom: 15px; }
        .item-desc .icon { 
            font-size: 24px; margin-right: 15px; width: 40px; height: 40px; display: flex; 
            align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;
        }

        .audio-upload-section {
            margin-top: 20px; padding: 15px; border: 1px dashed #666; border-radius: 10px; background: rgba(0,0,0,0.3);
        }
        .audio-status { font-size: 14px; color: #aaa; margin-top: 5px; }
        .audio-status.ok { color: #00FF00; }
        .audio-status.error { color: #FF3333; }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        #screen-leaderboard { z-index: 70; }
        .leaderboard-panel {
            background: rgba(20, 20, 30, 0.98); border: 3px solid #FFD700;
            border-radius: 10px; padding: 20px; width: 90%; max-width: 500px;
            max-height: 80vh; overflow-y: auto; text-align: center; color: white;
        }
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .lb-table th { background: #333; color: #FFD700; padding: 10px; border-bottom: 2px solid #555; }
        .lb-table td { padding: 8px; border-bottom: 1px solid #444; }
        .lb-table tr:nth-child(even) { background: rgba(255,255,255,0.05); }
        .lb-rank-1 { color: #FFD700; font-weight: bold; font-size: 1.2em; }
        .lb-rank-2 { color: #C0C0C0; font-weight: bold; font-size: 1.1em; }
        .lb-rank-3 { color: #CD7F32; font-weight: bold; font-size: 1.1em; }
        .loading-text { color: #aaa; font-style: italic; margin: 20px; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <!-- é›å•¼éŸ³æ•ˆ -->
    <audio id="roosterAudio" src="å¤§é›é›å«.mp3" preload="auto"></audio>

    <div id="uiLayer">
        <div class="hud-top">
            <div class="hud-column">
                <div class="bar-container">
                    <div id="wallHpBar" class="hp-bar-fill"></div>
                    <div id="wallHpText" class="bar-text">é“å£‡éˆåŠ›: 100%</div>
                </div>
            </div>
            <div id="scoreDisplay">åŠŸå¾·å€¼: 0</div>
        </div>
        
        <div class="left-controls" id="leftControls" style="display: none;">
            <div id="playerNameDisplay">--- é“å£«</div>
            <div style="display: flex; gap: 10px;">
                <button class="control-btn active" id="musicToggleBtn" onclick="toggleGlobalMusic()" title="èƒŒæ™¯éŸ³æ¨‚é–‹é—œ">ğŸµ</button>
                <button class="control-btn" id="pauseBtn" onclick="togglePause()" title="æš«åœéŠæˆ²">â¸</button>
            </div>
        </div>
        
        <div class="hud-bottom">
            <div class="item-bar" onmousedown="event.stopPropagation()">
                <div class="item-slot" id="item-talisman" onclick="useItem('talisman')">
                    <svg class="item-icon-svg" width="30" height="30" viewBox="0 0 30 40">
                        <rect x="2" y="2" width="26" height="36" fill="#FDD835" stroke="#B8860B" stroke-width="2"/>
                        <text x="15" y="28" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="22" fill="#D50000" text-anchor="middle">ä»¤</text>
                    </svg>
                    <span class="item-name">ç¬¦ä»¤</span>
                    <div class="item-count" id="count-talisman">3</div>
                </div>
                <div class="item-slot" id="item-sword" onclick="useItem('sword')">
                    <svg class="item-icon-svg" width="30" height="30" viewBox="0 0 30 40">
                        <path d="M15 2 L15 25 M12 25 L18 25 M15 25 L15 35" stroke="#D32F2F" stroke-width="4" stroke-linecap="round" />
                        <path d="M10 25 L20 25" stroke="#B71C1C" stroke-width="3" stroke-linecap="round" />
                    </svg>
                    <span class="item-name">æ¡ƒæœ¨åŠ</span>
                    <div class="item-count" id="count-sword">2</div>
                </div>
                <div class="item-slot" id="item-bell" onclick="useItem('bell')">
                    <svg class="item-icon-svg" width="30" height="30" viewBox="0 0 30 40">
                        <path d="M15 10 L15 2" stroke="#FFD700" stroke-width="2" stroke-linecap="round" />
                        <path d="M15 10 Q9 10 9 4" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" />
                        <path d="M15 10 Q21 10 21 4" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" />
                        <line x1="15" y1="10" x2="15" y2="22" stroke="#B8860B" stroke-width="3" />
                        <line x1="15" y1="10" x2="15" y2="22" stroke="#FFD700" stroke-width="1.5" />
                        <rect x="13.5" y="13" width="3" height="1" fill="#B8860B" />
                        <rect x="13.5" y="16" width="3" height="1" fill="#B8860B" />
                        <rect x="13.5" y="19" width="3" height="1" fill="#B8860B" />
                        <path d="M15 22 Q8 22 5 36 L25 36 Q22 22 15 22 Z" fill="#FDD835" stroke="#B8860B" stroke-width="1.5" />
                        <path d="M15 22 L15 30" stroke="#B8860B" stroke-width="1" />
                        <path d="M9 36 L21 36" stroke="#B8860B" stroke-width="1" />
                    </svg>
                    <span class="item-name">å¸å…¬éˆƒ</span>
                    <div class="item-count" id="count-bell">1</div>
                </div>
            </div>

            <input type="text" id="gameTextInput" placeholder="è¼¸å…¥å°ç¾…æ‹¼éŸ³ (æŒ‰ Enter é€å‡º)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
    </div>

    <!-- 1. é¦–é  -->
    <div id="screen-home" class="screen">
        <h1 id="titleBtn">å¿…æ®ºï¼TÃ¢i-LÃ´ KuÃ­</h1>
        <p style="color:#ccc; font-size: 20px;">é»æ“Šæ¨™é¡Œé–‹å§‹é™å¦–ä¼é­”</p>
        <button class="btn" style="margin-top:20px; background:#444;" onclick="openLeaderboard()">ğŸ† è‹±é›„æ¦œ</button>
        <div class="footer-credit">Crafted with care by @Khiohtaigu</div>
    </div>

    <!-- 2. è¨­å®šé  Step 1 -->
    <div id="screen-setup-step1" class="screen hidden">
        <h2 style="color: #FFD700; margin-bottom: 40px;">è«‹é ˜æ³•é–€</h2>
        <p style="color: #ccc; margin-bottom: 30px;">é¸æ“‡æ‚¨ä¿®è¡Œçš„æµæ´¾ (é»æ“Šç¬¦ä»¤)</p>
        
        <div class="talisman-container">
            <!-- TLPA -->
            <div class="talisman-card" onclick="selectPinyin('tailo')">
                <svg class="talisman-full-svg" viewBox="0 0 140 320" style="width:100%; height:100%; pointer-events:none;">
                    <rect x="0" y="0" width="140" height="320" rx="5" ry="5" fill="#FFF176" />
                    <path d="M20 35 L30 45 L40 35" fill="none" stroke="#D50000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M65 25 L75 35 L85 25" fill="none" stroke="#D50000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M100 35 L110 45 L120 35" fill="none" stroke="#D50000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <text x="70" y="90" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="52" fill="#D50000" text-anchor="middle">æ••</text>
                    <text x="70" y="135" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="52" fill="#D50000" text-anchor="middle">ä»¤</text>
                    <path d="M50 120 Q 20 125, 20 150 L 20 290" fill="none" stroke="#D50000" stroke-width="4" stroke-linecap="round" />
                    <circle cx="20" cy="290" r="4" fill="#D50000" />
                    <path d="M90 120 Q 120 125, 120 150 L 120 290" fill="none" stroke="#D50000" stroke-width="4" stroke-linecap="round" />
                    <circle cx="120" cy="290" r="4" fill="#D50000" />
                    <text x="70" y="175" font-family="Arial, sans-serif" font-weight="bold" font-size="20" fill="#D50000" text-anchor="middle">TLPA</text>
                    <text x="70" y="210" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#D50000" text-anchor="middle">æ•™</text>
                    <text x="70" y="245" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#D50000" text-anchor="middle">éƒ¨</text>
                    <text x="70" y="280" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#D50000" text-anchor="middle">ç¾…</text>
                </svg>
            </div>
            <!-- POJ -->
            <div class="talisman-card" onclick="selectPinyin('poj')">
                <svg class="talisman-full-svg" viewBox="0 0 140 320" style="width:100%; height:100%; pointer-events:none;">
                    <rect x="0" y="0" width="140" height="320" rx="5" ry="5" fill="#D32F2F" />
                    <path d="M20 35 L30 45 L40 35" fill="none" stroke="#FFD700" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M65 25 L75 35 L85 25" fill="none" stroke="#FFD700" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M100 35 L110 45 L120 35" fill="none" stroke="#FFD700" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    <text x="70" y="90" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="52" fill="#FFD700" text-anchor="middle">æ••</text>
                    <text x="70" y="135" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="52" fill="#FFD700" text-anchor="middle">ä»¤</text>
                    <path d="M50 120 Q 20 125, 20 150 L 20 290" fill="none" stroke="#FFD700" stroke-width="4" stroke-linecap="round" />
                    <circle cx="20" cy="290" r="4" fill="#FFD700" />
                    <path d="M90 120 Q 120 125, 120 150 L 120 290" fill="none" stroke="#FFD700" stroke-width="4" stroke-linecap="round" />
                    <circle cx="120" cy="290" r="4" fill="#FFD700" />
                    <text x="70" y="175" font-family="Arial, sans-serif" font-weight="bold" font-size="20" fill="#FFD700" text-anchor="middle">POJ</text>
                    <text x="70" y="210" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#FFD700" text-anchor="middle">ç™½</text>
                    <text x="70" y="245" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#FFD700" text-anchor="middle">è©±</text>
                    <text x="70" y="280" font-family="'KaiTi', 'BiauKai', serif" font-weight="bold" font-size="32" fill="#FFD700" text-anchor="middle">å­—</text>
                </svg>
            </div>
        </div>
    </div>

    <!-- 3. è¨­å®šé  Step 2: è¼¸å…¥åå­—èˆ‡é›£åº¦ -->
    <div id="screen-setup-step2" class="screen hidden">
        <h2 style="color: #FFD700;">é“ç±ç™»éŒ„</h2>
        <div class="form-group">
            <input type="text" id="nameInput" placeholder="è«‹è¼¸å…¥é“å£«ä»£è™Ÿ/åç¨±" maxlength="20" autocomplete="off">
        </div>
        
        <h2 style="margin-top: 20px; font-size: 24px;">é¸æ“‡è©¦ç…‰é›£åº¦</h2>
        <div class="btn-group">
            <button class="btn difficulty-btn selected" data-diff="A">A ç°¡å–®</button>
            <button class="btn difficulty-btn" data-diff="B">B æ™®é€š</button>
            <button class="btn difficulty-btn" data-diff="C">C å›°é›£</button>
        </div>

        <div class="audio-upload-section" style="display: none;">
            <h3 style="color:#FFF; margin:0 0 10px 0; font-size:18px;">ğŸ” é›å•¼è²è¨­å®š</h3>
            <input type="file" id="soundUpload" accept="audio/*" style="color:white;">
            <div id="audioStatus" class="audio-status"></div>
        </div>

        <button class="btn" id="toInstructionsBtn" style="margin-top: 30px; background: #28a745; font-size: 28px;">ä¸‹ä¸€æ­¥</button>
    </div>

    <!-- 2.5 éŠæˆ²èªªæ˜é  -->
    <div id="screen-instructions" class="screen hidden">
        <div class="instruction-panel">
            <div class="instruction-title">ğŸ“œ é“å£«æ‰‹å†Š (éŠæˆ²èªªæ˜)</div>
            
            <div class="instruction-section">
                <h3>âš”ï¸ ç²å‹æ¢ä»¶ <span style="color:#FFD700; font-size: 18px;">(æ–°!)</span></h3>
                <p>1. ç¾åœ¨æ˜¯æ¼«æ¼«é•·å¤œï¼Œè«‹å …å®ˆ<strong>é“å£‡</strong>ã€‚</p>
                <p>2. æ³¨æ„å¤©ä¸Šçš„<strong>æœˆäº®</strong>ï¼Œç•¶å®ƒè½ä¸‹ã€<strong>å¤ªé™½å‡èµ·</strong>ã€ä¸”<strong>å…¬é›å•¼å«</strong>æ™‚ï¼Œå³ç‚ºç²å‹ï¼</p>
                <p>3. éœ€å …æŒ <strong>5 åˆ†é˜ (300ç§’)</strong>ã€‚</p>
            </div>

            <div class="instruction-section">
                <h3>âš”ï¸ é™å¦–è¦å‰‡</h3>
                <p>é¬¼æ€ªèº«ä¸Šé¡¯ç¤ºæ¼¢å­—èˆ‡æ‹¼éŸ³ï¼Œè¼¸å…¥æ­£ç¢ºæ‹¼éŸ³å¾ŒæŒ‰ <strong>Enter</strong> ç™¼å°„æ³•è¡“ã€‚</p>
            </div>

            <div class="instruction-section">
                <h3>ğŸ’ æ³•å¯¶èˆ‡å……èƒ½</h3>
                <div class="item-desc">
                    <div class="icon">ä»¤</div>
                    <span><strong>ç¬¦ä»¤</strong>ï¼šæ¶ˆæ»…æœ€è¿‘çš„ä¸€éš»é¬¼ã€‚<span style="color:#aaa; font-size:14px;">(æ¯æ‰‹å‹• 5 æ–¬ç²å¾—)</span></span>
                </div>
                <div class="item-desc">
                    <div class="icon">åŠ</div>
                    <span><strong>æ¡ƒæœ¨åŠ</strong>ï¼šæ¶ˆæ»…å ´ä¸Šä¸€åŠçš„é¬¼ã€‚<span style="color:#aaa; font-size:14px;">(æ¯æ‰‹å‹• 10 æ–¬ç²å¾—)</span></span>
                </div>
                <div class="item-desc">
                    <div class="icon">éˆƒ</div>
                    <span><strong>å¸å…¬éˆƒ</strong>ï¼šæ¶ˆæ»…å…¨å ´æ‰€æœ‰é¬¼æ€ªã€‚<span style="color:#aaa; font-size:14px;">(æ¯æ‰‹å‹• 20 æ–¬ç²å¾—)</span></span>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="startGameBtn" style="background: #28a745; font-size: 28px; padding: 10px 60px;">é–‹å§‹é™¤å¦–</button>
            </div>
        </div>
    </div>

    <!-- æš«åœç•«é¢ -->
    <div id="screen-paused" class="screen hidden">
        <h1 style="border: none; background: none; font-size: 60px;">æš«åœ</h1>
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <button class="btn" onclick="togglePause()" style="font-size: 30px; padding: 15px 50px;">ç¹¼çºŒæˆ°é¬¥</button>
            <button class="btn" onclick="quitGame()" style="font-size: 30px; padding: 15px 50px; background: #8B0000; border-color: #ff3333;">çµæŸéŠæˆ²</button>
        </div>
    </div>

    <!-- çµæŸç•«é¢ -->
    <div id="screen-gameover" class="screen hidden">
        <h1 id="endTitle" style="color: #ff3333; border:none; background:none; font-size: 60px;">é“å£‡å¤±å®ˆï¼</h1>
        <div id="rankDisplay" class="rank-badge">å…¥é–€é“ç«¥</div>
        <h2 style="color: white; font-size: 24px;">æœ€çµ‚åŠŸå¾·å€¼: <span id="finalScore" style="color: #FFD700;">0</span></h2>
        
        <!-- æ’è¡Œæ¦œé¡¯ç¤ºå€ -->
        <div style="margin: 15px 0;">
            <button class="btn" style="background:#444; font-size:16px; padding:8px 20px;" onclick="openLeaderboard()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>

        <div class="analysis-box">
            <div class="analysis-title">â˜¯ï¸ å¼µå¤©å¸«é–‹ç¤º</div>
            <div id="geminiAnalysisContent">æ­£åœ¨æ­è«‹å¤©å¸«é™ç¤º...</div>
        </div>
        
        <div style="display: flex; gap: 20px; margin-top: 30px;">
            <button class="btn" id="restartBtn">å†æ¬¡æŒ‘æˆ°</button>
            <button class="btn" id="homeBtn" style="background: #555; border-color: #999;">å›åˆ°é¦–é </button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œè¦–çª— -->
    <div id="screen-leaderboard" class="screen hidden">
        <div class="leaderboard-panel">
            <h2 style="color: #FFD700; margin-bottom: 20px;">ğŸ“œ å°ç¥æ¦œ (Top 10)</h2>
            <div id="leaderboardContent">
                <p class="loading-text">æ­£åœ¨è®€å–å¤©åº­åå†Š...</p>
            </div>
            <button class="btn" style="margin-top: 20px;" onclick="closeLeaderboard()">é—œé–‰</button>
        </div>
    </div>

    <!-- Firebase SDK Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyBmVEMMCIb1RZAo_-TV0X_2cCGhNEvSzpY",
          authDomain: "tailo-kui-game.firebaseapp.com",
          projectId: "tailo-kui-game",
          storageBucket: "tailo-kui-game.firebasestorage.app",
          messagingSenderId: "1064824988000",
          appId: "1:1064824988000:web:c7e253d4d9104eda91be05"
        };

        let app, db;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // ä¸Šå‚³æˆç¸¾å‡½å¼ (æš´éœ²çµ¦å…¨åŸŸä½¿ç”¨)
        window.saveScoreToFirebase = async (name, score) => {
            if (!db) return;
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: name,
                    score: score,
                    date: new Date().toISOString() // å„²å­˜æ™‚é–“
                });
                console.log("Score saved!");
            } catch (e) {
                console.error("Error adding score: ", e);
            }
        };

        // è®€å–æ’è¡Œæ¦œå‡½å¼ (æš´éœ²çµ¦å…¨åŸŸä½¿ç”¨)
        window.fetchLeaderboard = async () => {
            const contentDiv = document.getElementById('leaderboardContent');
            contentDiv.innerHTML = '<p class="loading-text">æ­£åœ¨è®€å–å¤©åº­åå†Š...</p>';
            
            if (!db) {
                contentDiv.innerHTML = '<p style="color:red">ç„¡æ³•é€£ç·šè‡³å¤©åº­è³‡æ–™åº«</p>';
                return;
            }

            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    contentDiv.innerHTML = '<p>ç›®å‰å°šç„¡äººç™»æ¦œã€‚</p>';
                    return;
                }

                let html = `
                    <table class="lb-table">
                        <thead><tr><th>åæ¬¡</th><th>é“è™Ÿ</th><th>åŠŸå¾·å€¼</th></tr></thead>
                        <tbody>
                `;
                
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let rankClass = "";
                    if (rank === 1) rankClass = "lb-rank-1";
                    else if (rank === 2) rankClass = "lb-rank-2";
                    else if (rank === 3) rankClass = "lb-rank-3";
                    
                    // ç°¡å–®é˜²è­· XSS
                    const safeName = data.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    
                    html += `
                        <tr>
                            <td><span class="${rankClass}">${rank}</span></td>
                            <td>${safeName}</td>
                            <td style="color:#FFD700">${data.score}</td>
                        </tr>
                    `;
                    rank++;
                });
                
                html += '</tbody></table>';
                contentDiv.innerHTML = html;
            } catch (e) {
                console.error("Error fetching leaderboard: ", e);
                contentDiv.innerHTML = '<p style="color:red">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è³‡æ–™åº«æ¬Šé™ã€‚</p>';
            }
        };

        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (æ¸¬è©¦ç”¨)
        window.clearAllScores = async () => {
            if (!db) return;
            const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼š");
            if (password !== "1234") { 
                alert("å¯†ç¢¼éŒ¯èª¤");
                return;
            }
            
            const confirmDelete = confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰æ’è¡Œæ¦œç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ");
            if (!confirmDelete) return;

            try {
                console.log("é–‹å§‹åˆªé™¤...");
                const q = query(collection(db, "leaderboard"));
                const querySnapshot = await getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                alert("ğŸ—‘ï¸ è³‡æ–™åº«å·²æ¸…ç©ºï¼");
                if(window.fetchLeaderboard) window.fetchLeaderboard(); 
            } catch (e) {
                console.error("åˆªé™¤å¤±æ•—: ", e);
                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯");
            }
        };
    </script>

    <!-- ä¸»éŠæˆ²é‚è¼¯ -->
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameInput = document.getElementById('gameTextInput');
        const roosterAudio = document.getElementById('roosterAudio');
        const musicBtn = document.getElementById('musicToggleBtn');
        
        let hasStartedGame = false; 
        roosterAudio.volume = 1.0; 

        // --- Web Audio API BGM Setup ---
        let audioCtx;
        let bgmGainNode;
        let bgmEnabled = true;
        let nextNoteTime = 0;
        let schedulerTimer = null;
        let currentNote = 0;
        const tempo = 100; 
        const secondsPerBeat = 60.0 / tempo;
        
        let nextGhostColor = '#4FC3F7';

        const rhythmPattern = [
            { type: 0, vel: 1.0 }, { type: 1, vel: 0.6 }, 
            { type: 0, vel: 0.8 }, { type: 1, vel: 0.6 }, 
            { type: 0, vel: 1.0 }, { type: 0, vel: 0.8 }, 
            { type: 1, vel: 0.8 }, { type: 1, vel: 0.6 }
        ];
        
        function getRandomColor() {
            const colors = ['#4FC3F7', '#795548', '#D32F2F', '#9C27B0', '#FFD700', '#555'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                bgmGainNode = audioCtx.createGain();
                bgmGainNode.gain.value = 0.5; 
                bgmGainNode.connect(audioCtx.destination);
                nextNoteTime = audioCtx.currentTime;
                if (!schedulerTimer) schedulerTimer = setInterval(scheduler, 25);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type, time, velocity) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(bgmGainNode);

            if (type === 0) {
                osc.type = 'sine'; osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);
                gain.gain.setValueAtTime(velocity, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                osc.start(time); osc.stop(time + 0.3);
            } else {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, time);
                gain.gain.setValueAtTime(velocity * 0.5, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
                osc.start(time); osc.stop(time + 0.05);
            }
        }

        function playTalismanSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const bufferSize = audioCtx.sampleRate * 0.15;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.setValueAtTime(800, t);
            filter.frequency.exponentialRampToValueAtTime(2000, t + 0.1);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.8, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(t);
        }

        function playSwordSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'highpass'; noiseFilter.frequency.value = 1000;
            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(0.8, t); noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(audioCtx.destination);
            noise.start(t);

            const freqs = [600, 1250, 1800, 2500, 4200];
            const decays = [0.8, 0.6, 0.5, 0.3, 0.2];
            freqs.forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = i % 2 === 0 ? 'sine' : 'triangle'; 
                osc.frequency.value = f;
                gain.gain.setValueAtTime(0.3 / (i + 1), t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + decays[i]);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(t); osc.stop(t + decays[i]);
            });
        }

        function playBellSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const freqs = [2000, 3500, 5200, 9000];
            freqs.forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(f, t);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.3 / (i + 1), t + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5 - (i * 0.2)); 
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(t); osc.stop(t + 2.0);
            });
        }

        function scheduler() {
            if (!audioCtx) return;
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                const beat = rhythmPattern[currentNote];
                if ((gameState === 'PLAYING' || gameState === 'SETUP') && bgmEnabled) { 
                    playSound(beat.type, nextNoteTime, beat.vel);
                }
                nextNoteTime += (secondsPerBeat * 0.5); 
                currentNote = (currentNote + 1) % rhythmPattern.length;
            }
        }

        function toggleGlobalMusic() {
            bgmEnabled = !bgmEnabled;
            updateMusicButton();
            if (bgmEnabled) {
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                else if (!audioCtx) initAudio();
                if(bgmGainNode) {
                    bgmGainNode.gain.cancelScheduledValues(audioCtx.currentTime);
                    bgmGainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                }
            } else {
                if(bgmGainNode) {
                    bgmGainNode.gain.cancelScheduledValues(audioCtx.currentTime);
                    bgmGainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                }
            }
        }

        function updateMusicButton() {
            if (bgmEnabled) {
                musicBtn.innerText = "ğŸµ"; musicBtn.classList.add("active"); musicBtn.title = "é—œé–‰èƒŒæ™¯éŸ³æ¨‚";
            } else {
                musicBtn.innerText = "ğŸ”‡"; musicBtn.classList.remove("active"); musicBtn.title = "é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚";
            }
        }

        // --- é¸æ“‡æ‹¼éŸ³ (Step 1) ---
        function selectPinyin(mode) {
            romanizationMode = mode;
            if(bgmEnabled) { initAudio(); gameState = 'SETUP'; }
            document.getElementById('gameTextInput').placeholder = 
                romanizationMode === 'poj' ? "è¼¸å…¥ç™½è©±å­— POJ" : "è¼¸å…¥å°ç¾…æ‹¼éŸ³ (TÃ¢i-lÃ´)";
            document.getElementById('screen-setup-step1').classList.add('hidden');
            document.getElementById('screen-setup-step2').classList.remove('hidden');
        }

        // --- è²èª¿è½‰æ›å·¥å…· ---
        const toneMap = {
            'a1': 'a', 'a2': 'Ã¡', 'a3': 'Ã ', 'a4': 'ah', 'a5': 'Ã¢', 'a6': 'Ç', 'a7': 'Ä', 'a8': 'aÌ',
            'e1': 'e', 'e2': 'Ã©', 'e3': 'Ã¨', 'e4': 'eh', 'e5': 'Ãª', 'e6': 'Ä›', 'e7': 'Ä“', 'e8': 'eÌ',
            'i1': 'i', 'i2': 'Ã­', 'i3': 'Ã¬', 'i4': 'ih', 'i5': 'Ã®', 'i6': 'Ç', 'i7': 'Ä«', 'i8': 'iÌ',
            'o1': 'o', 'o2': 'Ã³', 'o3': 'Ã²', 'o4': 'oh', 'o5': 'Ã´', 'o6': 'Ç’', 'o7': 'Å', 'o8': 'oÌ',
            'u1': 'u', 'u2': 'Ãº', 'u3': 'Ã¹', 'u4': 'uh', 'u5': 'Ã»', 'u6': 'Ç”', 'u7': 'Å«', 'u8': 'uÌ',
            'm1': 'm', 'm2': 'á¸¿', 'm3': 'mÌ€', 'm4': 'mh', 'm5': 'mÌ‚', 'm6': 'mÌŒ', 'm7': 'mÌ„', 'm8': 'mÌ',
            'n1': 'n', 'n2': 'Å„', 'n3': 'Ç¹', 'n4': 'nh', 'n5': 'nÌ‚', 'n6': 'Åˆ', 'n7': 'nÌ„', 'n8': 'nÌ',
        };

        const processInput = (text) => {
            let result = text.toLowerCase();
            Object.keys(toneMap).forEach(key => { result = result.replaceAll(key, toneMap[key]); });
            return result;
        };

        // --- é¬¼æ€ªè©åº« ---
        const vocabBasic = [
            { hanzi: "æ°´é¬¼", tailo: "tsuÃ­-kuÃ­", poj: "chÃºi-kÃºi", numeric: ["tsui2-kui2", "chui2-kui2"], score: 50 },
            { hanzi: "ä¹é£Ÿé¬¼", tailo: "khit-tsiah-kuÃ­", poj: "khit-tsiah-kÃºi", numeric: ["khit4-tsiah8-kui2"], score: 60 },
            { hanzi: "ç™©ğ°£»é¬¼", tailo: "thÃ¡i-ko-kuÃ­", poj: "thÃ¡i-ko-kÃºi", numeric: ["thai2-ko1-kui2"], score: 60 },
            { hanzi: "ğ¢¯¾å£é¬¼", tailo: "mooh-piah-kuÃ­", poj: "mooh-piah-kÃºi", numeric: ["mooh4-piah4-kui2"], score: 60 },
            { hanzi: "åƒåœ¾é¬¼", tailo: "lap-sap-kuÃ­", poj: "lap-sap-kÃºi", numeric: ["lap4-sap4-kui2"], score: 60 },
            { hanzi: "ä¸æ­»é¬¼", tailo: "put-sÃº-kuÃ­", poj: "put-sÃº-kÃºi", numeric: ["put4-su2-kui2"], score: 80 },
            { hanzi: "é¬–æ¯›é¬¼", tailo: "sÃ¡m-mnÌ‚g-kuÃ­", poj: "sÃ¡m-mnÌ‚g-kÃºi", numeric: ["sam2-mng5-kui2"], score: 70 },
            { hanzi: "æ•£èµ¤é¬¼", tailo: "sÃ¡n-tshiah-kuÃ­", poj: "sÃ¡n-chhiah-kÃºi", numeric: ["san2-tshiah4-kui2", "san2-chhiah4-kui2"], score: 70 },
            { hanzi: "æ›¿æ­»é¬¼", tailo: "thÃ¨-sÃ­-kuÃ­", poj: "thÃ¨-sÃ­-kÃºi", numeric: ["the3-si2-kui2"], score: 70 },
            { hanzi: "ç­Šé¬¼", tailo: "kiÃ¡u-kuÃ­", poj: "kiÃ¡u-kÃºi", numeric: ["kiau2-kui2"], score: 60 },
            { hanzi: "é…’é¬¼", tailo: "tsiÃº-kuÃ­", poj: "chiÃº-kÃºi", numeric: ["tsiu2-kui2", "chiu2-kui2"], score: 50 },
            { hanzi: "éŒ¢é¬¼", tailo: "tsÃ®nn-kuÃ­", poj: "chÃ®nn-kÃºi", numeric: ["tsinn5-kui2", "chinn5-kui2"], score: 50 },
            { hanzi: "é–€é¬¼", tailo: "mnÌ‚g-kuÃ­", poj: "mnÌ‚g-kÃºi", numeric: ["mng5-kui2"], score: 50 },
            { hanzi: "å¼•é¬¼å…¥å®…", tailo: "Ã­n-kuÃ­-liÌp-theÌh", poj: "Ã­n-kÃºi-liÌp-theÌh", numeric: ["in2-kui2-lip8-theh8"], score: 80 },
            { hanzi: "å°é¬¼ä»”æ®¼", tailo: "siÃ¡u-kuÃ­-Ã¡-khak", poj: "siÃ¡u-kÃºi-Ã¡-khak", numeric: ["siau2-kui2-a2-khak4"], score: 80 },
            { hanzi: "é›™é¢åˆ€é¬¼", tailo: "siang-bÄ«n-to-kuÃ­", poj: "siang-bÄ«n-to-kÃºi", numeric: ["siang1-bin7-to1-kui2"], score: 90 },
            { hanzi: "é¬¼é ­åˆ€", tailo: "kuÃ­-thÃ¢u-to", poj: "kÃºi-thÃ¢u-to", numeric: ["kui2-thau5-to1"], score: 80 },
            { hanzi: "è€³ç©ºé¬¼ä»”", tailo: "hÄ«nn-khang-kuÃ­-Ã¡", poj: "hÄ«nn-khang-kÃºi-Ã¡", numeric: ["hinn7-khang1-kui2-a2"], score: 90 },
            { hanzi: "æµé¬¼", tailo: "iau-kuÃ­", poj: "iau-kÃºi", numeric: ["iau1-kui2"], score: 50 },
            { hanzi: "æ­¹é¬¼", tailo: "phÃ¡inn-kuÃ­", poj: "phÃ¡inn-kÃºi", numeric: ["phainn2-kui2"], score: 60 },
            { hanzi: "æ­¹é¬¼ğ¤†¬é ­", tailo: "phÃ¡inn-kuÃ­-tshuÄ-thÃ¢u", poj: "phÃ¡inn-kÃºi-chhÅa-thÃ¢u", numeric: ["phainn2-kui2-tshua7-thau5"], score: 80 },
            { hanzi: "è®Šé¬¼è®Šæ€ª", tailo: "pÃ¬nn-kuÃ­-pÃ¬nn-kuÃ i", poj: "pÃ¬nn-kÃºi-pÃ¬nn-koÃ i", numeric: ["pinn3-kui2-pinn3-kuai3", "pinn3-kui2-pinn3-koai3"], score: 100 },
            { hanzi: "ä»¥é¬¼å°±é¬¼", tailo: "Ã­-kuÃ­-tsiÅ«-kuÃ­", poj: "Ã­-kÃºi-chiÅ«-kÃºi", numeric: ["i2-kui2-tsiu7-kui2"], score: 80 },
            { hanzi: "åŠé¬¼ä»”", tailo: "tiÃ u-kuÃ­-Ã¡", poj: "tiÃ u-kÃºi-Ã¡", numeric: ["tiau3-kui2-a2"], score: 70 },
            { hanzi: "ç¶ è±†é¬¼", tailo: "liÌk-tÄu-kuÃ­", poj: "liÌk-tÄu-kÃºi", numeric: ["lik8-tau7-kui2"], score: 60 }
        ];
        
        const vocabAdvanced = [
            { hanzi: "å€©é¬¼æè—¥å–®", tailo: "tshiÃ nn-kuÃ­-theÌh-ioÌh-tuann", poj: "chhiÃ nn-kÃºi-theÌh-ioÌh-toann", numeric: ["tshiann3-kui2-theh8-ioh8-tuann1"], score: 130 },
            { hanzi: "æµé¬¼å‡ç´°è†©", tailo: "iau-kuÃ­-kÃ©-sÃ¨-lÄ«", poj: "iau-kÃºi-kÃ©-sÃ¨-lÄ«", numeric: ["iau1-kui2-ke2-se3-li7"], score: 120 },
            { hanzi: "å…§ç¥é€šå¤–é¬¼", tailo: "lÄi-sÃ®n-thong-guÄ-kuÃ­", poj: "lÄi-sÃ®n-thong-gÅa-kÃºi", numeric: ["lai7-sin5-thong1-gua7-kui2", "lai7-sin5-thong1-goa7-kui2"], score: 120 },
            { hanzi: "äººç‰½æ¯‹è¡Œé¬¼ç‰½ç¡ç¡è¡Œ", tailo: "lÃ¢ng-khan-mÌ„-kiÃ¢nn-kuÃ­-khan-khÃ³k-khÃ³k-kiÃ¢nn", poj: "lÃ¢ng-khan-mÌ„-kiÃ¢nn-kÃºi-khan-khÃ³k-khÃ³k-kiÃ¢nn", numeric: ["lang5-khan1-m7-kiann5-kui2-khan1-khok4-khok4-kiann5"], score: 150 },
            { hanzi: "æœ‰éŒ¢ä½¿é¬¼æœƒæŒ¨ç£¨", tailo: "Å«-tsÃ®nn-sÃ¡i-kuÃ­-Ä“-ue-bÅ", poj: "Å«-chÃ®nn-sÃ¡i-kÃºi-Ä“-ue-bÅ", numeric: ["u7-tsinn5-sai2-kui2-e7-ue1-bo7"], score: 140 },
            { hanzi: "ç™½éœ²æ°´è¼ƒæ¯’é¬¼", tailo: "peÌh-lÅo-tsuÃ­-khah-toÌk-kuÃ­", poj: "peÌh-lÅo-chÃºi-khah-toÌk-kÃºi", numeric: ["peh8-loo7-tsui2-khah4-tok8-kui2"], score: 140 },
            { hanzi: "æ˜¥é›ºæ›æ­»é¬¼", tailo: "tshun-bÃ´ng-phaÌk-sÃ­-kuÃ­", poj: "chhun-bÃ´ng-phaÌk-sÃ­-kÃºi", numeric: ["tshun1-bong5-phak8-si2-kui2"], score: 130 }
        ];

        let gameState = 'HOME'; 
        let score = 0;
        let killCount = 0; 
        let frames = 0;
        let playerName = "ç©å®¶A";
        let difficulty = 'A';
        let romanizationMode = 'tailo'; 
        // --- é€™è£¡å·²ç¶“å¡«å…¥æ‚¨çš„ Key ---
        const apiKey = "AIzaSyBmVEMMCIb1RZAo_-TV0X_2cCGhNEvSzpY"; 
        let mistakes = []; 
        let isComposing = false;
        let isPaused = false;
        let isMuted = false;
        let nextSpawnTime = 0; 
        let nextGhostData = null; 
        
        // --- å‡å‹»éš¨æ©Ÿ (Shuffle Bag) ---
        let basicGhostBag = [];
        let advancedGhostBag = []; 
        let lastGhostWasAdvanced = false; 

        // --- æ™‚é–“ç³»çµ± ---
        const GAME_DURATION_SEC = 300; 
        let timeElapsed = 0; 

        const items = {
            talisman: { count: 3, name: 'ç¬¦ä»¤', threshold: 5 }, 
            sword: { count: 2, name: 'æ¡ƒæœ¨åŠ', threshold: 10 }, 
            bell: { count: 1, name: 'å¸å…¬éˆƒ', threshold: 20 }   
        };

        // ä¿®æ”¹ï¼šALTAR_X èˆ‡ DEFENSE_LINE_X ä»ä¿ç•™ç”¨æ–¼é‚è¼¯åˆ¤æ–·ï¼Œä½†ä¸å†ç¹ªè£½è¯éº—é“å£‡
        const ALTAR_X = 150; 
        const DEFENSE_LINE_X = 230; 
        
        let wallMaxHp = 1000;
        let wallHp = 1000;

        let taoist;
        let ghosts = [];
        let projectiles = [];
        let particles = [];
        let lanes = []; 

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const playHeight = canvas.height - 250;
            const laneCount = Math.floor(playHeight / 70); 
            lanes = [];
            for (let i = 0; i < laneCount; i++) lanes.push(100 + i * 70 + 35);
        }
        window.addEventListener('resize', resize);
        resize();

        // --- ç¹ªåœ–è¼”åŠ© (æ›´æ–°ï¼šåŠ å…¥æ‰€æœ‰ç‰¹æ®Šé¬¼æ€ªå½¢è±¡) ---
        function drawGhostAppearance(ctx, hanzi, bodyColor, radius) {
            ctx.shadowBlur = 0; 
            
            // 1. æ­¹é¬¼ğ¤†¬é ­ (å°é¬¼åœ¨å³é‚Š)
            if (hanzi === "æ­¹é¬¼ğ¤†¬é ­") {
                // ç•«å¾Œé¢çš„å°é¬¼ (ç¾åœ¨ç§»åˆ°å³é‚Š +30)
                ctx.save();
                ctx.translate(30, -20); // å¾€å³ç§»
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0,0, 15, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth=1; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(-4, -2, 3, 0, Math.PI*2); ctx.arc(4, -2, 3, 0, Math.PI*2); ctx.fill();
                ctx.restore();
                
                ctx.save();
                ctx.translate(30, 20); // å¾€å³ç§»
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0,0, 15, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth=1; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(-4, -2, 3, 0, Math.PI*2); ctx.arc(4, -2, 3, 0, Math.PI*2); ctx.fill();
                ctx.restore();

                // æœ¬é«”
                ctx.shadowColor = bodyColor; ctx.shadowBlur = 15;
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0; 
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // å…‡è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(-12, -8); ctx.lineTo(-4, -4); ctx.stroke(); // æ€’çœ‰
                ctx.beginPath(); ctx.moveTo(12, -8); ctx.lineTo(4, -4); ctx.stroke();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(-5, 10); ctx.quadraticCurveTo(0, 5, 5, 10); ctx.stroke(); // å€’å˜´
            }
            // 2. ç­Šé¬¼ (çœ¼å‰æ˜¯æ’²å…‹ç‰Œ)
            else if (hanzi === "ç­Šé¬¼") {
                // æœ¬é«”
                ctx.fillStyle = '#D32F2F'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // æ’²å…‹ç‰Œ (ä¸‰å¼µæ‰‡å½¢)
                function drawCard(angle, x, y) {
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.fillStyle = '#FFF'; ctx.fillRect(-8, -12, 16, 24);
                    ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.strokeRect(-8, -12, 16, 24);
                    ctx.fillStyle = '#000'; ctx.fillText("â™ ", -4, 5);
                    ctx.restore();
                }
                drawCard(-0.5, -15, -10);
                drawCard(0, 0, -15);
                drawCard(0.5, 15, -10);
            }
            // 3. ç™©ğ°£»é¬¼ (å¾ˆé«’çš„æ¨£å­)
            else if (hanzi === "ç™©ğ°£»é¬¼") {
                ctx.fillStyle = '#556B2F'; // é«’ç¶ è‰²
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                // é«’æ–‘é»
                ctx.fillStyle = '#333'; 
                ctx.beginPath(); ctx.arc(-10, 5, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(8, -8, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(5, 12, 2, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#2F4F4F'; ctx.lineWidth = 2; ctx.stroke();
                // è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 5, 0, Math.PI * 2); ctx.arc(8, -4, 5, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 1, 0, Math.PI * 2); ctx.arc(8, -4, 1, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle='#000'; ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(5, 10); ctx.stroke();
            }
            // 4. ç¶ è±†é¬¼ (ç¶ è±†å½¢è±¡)
            else if (hanzi === "ç¶ è±†é¬¼") {
                ctx.fillStyle = '#228B22'; // ç¶ è±†è‰²
                ctx.beginPath(); ctx.ellipse(0, 0, radius * 0.7, radius, 0, 0, Math.PI*2); ctx.fill();
                // ç¶ è±†çš„å°ç™½é»
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.beginPath(); ctx.ellipse(-5, -5, 2, 5, 0.5, 0, Math.PI*2); ctx.fill();
                // è‡‰
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-5, -5, 2, 0, Math.PI*2); ctx.arc(5, -5, 2, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle='#000'; ctx.beginPath(); ctx.arc(0, 5, 3, 0, Math.PI, false); ctx.stroke();
            }
            // 5. ğ¢¯¾å£é¬¼ (å·¦å´æœ‰ä¸€é“ç‰†)
            else if (hanzi === "ğ¢¯¾å£é¬¼") {
                // ç‰†
                ctx.fillStyle = '#808080'; ctx.fillRect(-radius - 15, -radius-10, 10, radius*2+20);
                ctx.strokeStyle = '#555'; ctx.strokeRect(-radius - 15, -radius-10, 10, radius*2+20);
                // ç£šç´‹
                ctx.beginPath(); ctx.moveTo(-radius-15, 0); ctx.lineTo(-radius-5, 0); ctx.stroke();
                
                // æœ¬é«” (è²¼è‘—ç‰†)
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // è‡‰è½‰å·¦çœ‹ç‰†
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-12, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-14, -4, 2, 0, Math.PI * 2); ctx.fill();
            }
            // 6. æ˜¥é›ºæ›æ­»é¬¼ (ç•«å€‹å¤ªé™½ + å¾ˆç†±æµæ±—)
            else if (hanzi === "æ˜¥é›ºæ›æ­»é¬¼") {
                // å¤ªé™½åœ¨æœ¬é«”ä¸Šæ–¹
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(0, -radius - 15, 10, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2;
                for(let i=0; i<8; i++) {
                    let angle = i * Math.PI / 4;
                    ctx.beginPath();
                    ctx.moveTo(Math.cos(angle)*10, -radius - 15 + Math.sin(angle)*10);
                    ctx.lineTo(Math.cos(angle)*18, -radius - 15 + Math.sin(angle)*18);
                    ctx.stroke();
                }
                // æœ¬é«” (ç†±æšˆï¼Œç´…è‰²)
                ctx.fillStyle = '#FF6347'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // æšˆçœ©çœ¼
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-6, -5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(6, -5); ctx.lineTo(10, -5); ctx.stroke();
                // å¤§å˜´å–˜æ°£
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(0, 10, 6, 8, 0, 0, Math.PI*2); ctx.fill();
                // æ±—ç  (è—è‰²æ°´æ»´)
                ctx.fillStyle = '#00BFFF';
                ctx.beginPath(); ctx.arc(15, -10, 4, 0, Math.PI*2); ctx.fill(); // å³é¡é ­
                ctx.beginPath(); ctx.arc(-15, 5, 3, 0, Math.PI*2); ctx.fill(); // å·¦è‡‰é °
            }
            // 7. é…’é¬¼ (æ‹¿é…’ç“¶)
            else if (hanzi === "é…’é¬¼" || hanzi.includes("é…’")) {
                ctx.fillStyle = '#FFCDD2'; // é†‰ç´…è‡‰
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#D32F2F'; ctx.lineWidth = 2; ctx.stroke();
                // è…®ç´…
                ctx.fillStyle = '#FF5252'; 
                ctx.globalAlpha = 0.6;
                ctx.beginPath(); ctx.arc(-12, 5, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(12, 5, 5, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
                // çœ¼ç› (æšˆ)
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-6, -5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(6, -5); ctx.lineTo(10, -5); ctx.stroke();
                // æ‹¿é…’ç“¶ (åœ¨å³å´)
                ctx.save(); ctx.translate(radius, 10); ctx.rotate(0.3);
                ctx.fillStyle = '#8B4513'; ctx.fillRect(-5, -15, 10, 25); // ç“¶èº«
                ctx.fillRect(-2, -20, 4, 5); // ç“¶é ¸
                ctx.restore();
            }
            // 8. è€³ç©ºé¬¼ä»” (ç•«å…©å€‹å¤§è€³æœµ)
            else if (hanzi === "è€³ç©ºé¬¼ä»”") {
                // å·¦è€³
                ctx.fillStyle = bodyColor; 
                ctx.beginPath(); ctx.ellipse(-radius-5, 0, 8, 12, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                // å³è€³
                ctx.beginPath(); ctx.ellipse(radius+5, 0, 8, 12, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                
                // æœ¬é«”
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.stroke();
                // è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
            }
            // 9. åŠé¬¼ä»” (å³å´ç•«ä¸€éš»äºŒèƒ¡)
            else if (hanzi === "åŠé¬¼ä»”") {
                // æœ¬é«”
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                
                // äºŒèƒ¡ (å³å´)
                ctx.save(); ctx.translate(radius + 15, 0);
                ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(0, -25); ctx.lineTo(0, 15); ctx.stroke(); // ç´æ¡¿
                ctx.fillStyle = '#A0522D'; ctx.fillRect(-5, 10, 10, 10); // ç´ç­’
                ctx.strokeRect(-5, 10, 10, 10);
                ctx.restore();
            }
            // 10. æ­¹é¬¼ (ç•«å…‡è‡‰)
            else if (hanzi === "æ­¹é¬¼") {
                ctx.fillStyle = '#800000'; // æ·±ç´…
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                
                ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3;
                // æ€’çœ‰
                ctx.beginPath(); ctx.moveTo(-15, -10); ctx.lineTo(-5, -5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, -10); ctx.lineTo(5, -5); ctx.stroke();
                // å°–ç‰™å˜´
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.moveTo(-10, 10); ctx.lineTo(10, 10); ctx.lineTo(0, 20); ctx.fill();
                // çœ¼
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(-10, 0, 3, 0, Math.PI*2); ctx.arc(10, 0, 3, 0, Math.PI*2); ctx.fill();
            }
            // 11. å€©é¬¼æè—¥å–® (ç•«ä¸€é¡†è† å›Š)
            else if (hanzi === "å€©é¬¼æè—¥å–®") {
                // æœ¬é«”
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                
                // è† å›Š (æ‰‹ä¸­)
                ctx.save(); ctx.translate(15, 10); ctx.rotate(-0.5);
                ctx.fillStyle = '#F00'; ctx.beginPath(); ctx.arc(0, -5, 5, Math.PI, 0); ctx.fill(); // ä¸Šç´…
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(0, 5, 5, 0, Math.PI); ctx.fill(); // ä¸‹ç™½
                ctx.fillRect(-5, -5, 10, 10); // ä¸­é–“æ¥åˆ
                ctx.fillStyle = '#F00'; ctx.fillRect(-5, -5, 10, 5); 
                ctx.strokeRect(-5, -5, 10, 10);
                ctx.restore();
            }
            // 12. é›™é¢åˆ€é¬¼ (å…©å€‹è‡‰ï¼Œéƒ½æ˜¯èœåˆ€)
            else if (hanzi === "é›™é¢åˆ€é¬¼") {
                // ç•«å…©æŠŠåˆ€èƒŒå°èƒŒ
                function drawCleaver(x, scaleX) {
                    ctx.save(); ctx.translate(x, 0); ctx.scale(scaleX, 1);
                    ctx.fillStyle = '#C0C0C0'; 
                    ctx.beginPath(); ctx.moveTo(-10, -20); ctx.lineTo(15, -20); ctx.lineTo(15, 20); ctx.lineTo(-10, 20); ctx.fill();
                    ctx.strokeStyle = '#555'; ctx.stroke();
                    // åˆ€æŸ„
                    ctx.fillStyle = '#8B4513'; ctx.fillRect(-5, 20, 5, 10);
                    // è‡‰ (ç°¡å–®çš„çœ¼ç›åœ¨åˆ€é¢ä¸Š)
                    ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(5, -5, 2, 0, Math.PI*2); ctx.fill();
                    ctx.restore();
                }
                drawCleaver(-10, 1); // å·¦è‡‰
                drawCleaver(10, -1); // å³è‡‰
            }
            // 13. æœ‰éŒ¢ä½¿é¬¼æœƒæŒ¨ç£¨ (å‰é¢ç•«ä¸€å€‹çŸ³ç£¨)
            else if (hanzi === "æœ‰éŒ¢ä½¿é¬¼æœƒæŒ¨ç£¨") {
                // æœ¬é«”åœ¨å¾Œ
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, -10, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                
                // çŸ³ç£¨åœ¨å‰
                ctx.fillStyle = '#808080'; 
                ctx.beginPath(); ctx.ellipse(0, 10, 20, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // åº•åº§
                ctx.beginPath(); ctx.ellipse(0, 5, 15, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // ä¸Šåº§
                // æŠŠæ‰‹
                ctx.beginPath(); ctx.moveTo(5, 5); ctx.lineTo(15, 0); ctx.stroke();
            }
            // 14. è®Šé¬¼è®Šæ€ª (ä¸€åŠé¬¼ä¸€åŠå¦–æ€ª)
            else if (hanzi === "è®Šé¬¼è®Šæ€ª") {
                ctx.save();
                // å·¦åŠé‚Š (æ­£å¸¸é¬¼)
                ctx.beginPath(); ctx.arc(0, 0, radius, Math.PI/2, -Math.PI/2); 
                ctx.fillStyle = '#ADD8E6'; ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 3, 0, Math.PI*2); ctx.fill(); // å·¦çœ¼
                
                // å³åŠé‚Š (å¦–æ€ª - ç¶ è‰²å°–åˆº)
                ctx.beginPath(); ctx.arc(0, 0, radius, -Math.PI/2, Math.PI/2);
                ctx.fillStyle = '#32CD32'; ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.arc(8, -6, 5, 0, Math.PI*2); ctx.fill(); // å³ç´…çœ¼
                ctx.beginPath(); ctx.moveTo(5, 10); ctx.lineTo(10, 15); ctx.lineTo(15, 10); ctx.fillStyle='#FFF'; ctx.fill(); // ç ç‰™
                ctx.restore();
            }
            // 15. ä¸æ­»é¬¼ (å¥½è‰²ï¼Œçœ¼ç›æ„›å¿ƒï¼Œæµå£æ°´)
            else if (hanzi === "ä¸æ­»é¬¼") {
                ctx.fillStyle = '#FF69B4'; // é¨·ç²‰ç´…
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // æ„›å¿ƒçœ¼
                ctx.fillStyle = '#FF0000'; 
                ctx.font = '16px Arial'; ctx.fillText("â™¥", -12, 0); ctx.fillText("â™¥", 4, 0);
                // æµå£æ°´
                ctx.fillStyle = '#E0FFFF'; 
                ctx.beginPath(); ctx.moveTo(5, 10); ctx.quadraticCurveTo(10, 20, 5, 25); ctx.quadraticCurveTo(0, 20, 5, 10); ctx.fill();
                ctx.strokeStyle = '#ADD8E6'; ctx.stroke();
            }
            // 16. æ›¿æ­»é¬¼ (æ¼‚æµ®çš„å¹½éˆåœ¨å¾Œé¢)
            else if (hanzi === "æ›¿æ­»é¬¼") {
                // å¾Œé¢çš„å¹½éˆ
                ctx.save();
                ctx.translate(15, -15);
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = '#FFF'; 
                ctx.beginPath(); ctx.arc(0, 0, 15, Math.PI, 0); ctx.lineTo(15, 20); ctx.lineTo(0, 10); ctx.lineTo(-15, 20); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-5, -2, 2, 0, Math.PI*2); ctx.arc(5, -2, 2, 0, Math.PI*2); ctx.fill();
                ctx.restore();
                
                // æœ¬é«”
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                // è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
            }
            // 17. ä¹é£Ÿé¬¼ / æ•£èµ¤é¬¼ (è£œä¸ + ç ´ç¢—)
            else if (hanzi === "ä¹é£Ÿé¬¼" || hanzi === "æ•£èµ¤é¬¼") {
                ctx.fillStyle = '#8D6E63'; // é«’è¤è‰²
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#3E2723'; ctx.lineWidth = 2; ctx.stroke();
                // è£œä¸ (æ–¹å½¢)
                ctx.fillStyle = '#A1887F'; ctx.fillRect(-10, -10, 8, 8); ctx.strokeRect(-10, -10, 8, 8);
                ctx.fillStyle = '#6D4C41'; ctx.fillRect(5, 5, 6, 6); ctx.strokeRect(5, 5, 6, 6);
                // æ‹¿è‘—ç ´ç¢—
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 15, 8, 0, Math.PI, false); ctx.fill();
                // å“€å‚·çœ¼
                ctx.strokeStyle = '#000';
                ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-5, -2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(10, -5); ctx.lineTo(5, -2); ctx.stroke();
            }
            // 18. å…§ç¥é€šå¤–é¬¼ (å‰ç¥å¾Œé¬¼)
            else if (hanzi === "å…§ç¥é€šå¤–é¬¼") {
                // å¾Œé¢çš„é¬¼
                ctx.save(); ctx.translate(15, -10);
                ctx.fillStyle = '#555'; ctx.beginPath(); ctx.arc(0,0, radius-5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(5, -2, 2, 0, Math.PI*2); ctx.fill();
                ctx.restore();
                
                // å‰é¢çš„ç¥
                ctx.save(); ctx.translate(-5, 5);
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(0,0, radius, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2; ctx.stroke();
                // ç¥å¸½
                ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.moveTo(-15, -15); ctx.lineTo(15, -15); ctx.lineTo(0, -35); ctx.fill();
                // ç¥è‡‰
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(-5, 5); ctx.quadraticCurveTo(0, 10, 5, 5); ctx.stroke(); // å¾®ç¬‘
                ctx.restore();
            }
            // 19. é–€é¬¼ (æ–¹è‡‰é–€æ¿)
            else if (hanzi === "é–€é¬¼") {
                ctx.fillStyle = '#8B4513'; // æœ¨é–€è‰²
                ctx.fillRect(-radius, -radius-5, radius*2, radius*2+10);
                ctx.strokeStyle = '#3E2723'; ctx.strokeRect(-radius, -radius-5, radius*2, radius*2+10);
                // é–€ç¸«
                ctx.beginPath(); ctx.moveTo(0, -radius-5); ctx.lineTo(0, radius+5); ctx.stroke();
                // é–€æŠŠ
                ctx.fillStyle = '#FFD700'; 
                ctx.beginPath(); ctx.arc(-8, 0, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(8, 0, 3, 0, Math.PI*2); ctx.fill();
            }
            // 20. æµé¬¼ (é¤“é¬¼ï¼šç˜¦ï¼Œæ‘¸è‚šå­)
            else if (hanzi === "æµé¬¼") {
                ctx.save(); ctx.scale(0.7, 1.1); // è®Šç˜¦
                ctx.fillStyle = '#A9A9A9'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth=2; ctx.stroke();
                ctx.restore();
                
                // å¤§å¼µå˜´
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(0, -5, 8, 0, Math.PI*2); ctx.fill();
                // æ‰‹æ‘¸è‚šå­
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0, 15, 10, 0, Math.PI, false); ctx.stroke();
            }
            // 21. æµé¬¼å‡ç´°è†© (æ‹¿ç­·å­ï¼Œæµå£æ°´ï¼Œè£å®¢æ°£)
            else if (hanzi === "æµé¬¼å‡ç´°è†©") {
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                
                // è‡‰è½‰ä¸€é‚Š (è£æ²’çœ‹åˆ°)
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(0, -5, 6, 0, Math.PI * 2); ctx.fill(); // å·¦çœ¼
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(2, -5, 2, 0, Math.PI * 2); ctx.fill(); // çœ¼ç å‘å³çœ‹
                
                // å˜´å·´æµå£æ°´
                ctx.fillStyle = '#E0FFFF'; 
                ctx.beginPath(); ctx.arc(0, 5, 4, 0, Math.PI*2); ctx.fill();
                
                // æ‰‹æ‹¿ç­·å­
                ctx.save(); ctx.translate(15, 10);
                ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, -15); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(4, 0); ctx.lineTo(4, -15); ctx.stroke();
                ctx.restore();
            }
            // --- ä¿ç•™åŸæœ‰çš„å…¶ä»–ç‰¹è‰² ---
            // é¬¼é ­åˆ€ (é­šå½¢)
            else if (hanzi === "é¬¼é ­åˆ€") {
                ctx.shadowColor = '#00FF00'; ctx.shadowBlur = 15;
                ctx.scale(-1, 1);
                let gradient = ctx.createLinearGradient(-25, -10, 25, 10);
                gradient.addColorStop(0, '#FFFF00'); gradient.addColorStop(1, '#00FF7F'); 
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.moveTo(25, 0); ctx.lineTo(20, -15); ctx.lineTo(-10, -20); ctx.lineTo(-30, -5); 
                ctx.lineTo(-40, -15); ctx.lineTo(-35, 0); ctx.lineTo(-40, 15); ctx.lineTo(-30, 5); ctx.lineTo(10, 15); 
                ctx.closePath(); ctx.fill();
                ctx.lineWidth = 2; ctx.strokeStyle = '#006400'; ctx.stroke();
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(15, -5, 4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(15, -5, 2, 0, Math.PI*2); ctx.fill();
                ctx.scale(-1, 1); ctx.shadowBlur = 0;
            } 
            // éŒ¢é¬¼ (é‡‘å¹£å½¢)
            else if (hanzi === "éŒ¢é¬¼") {
                ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 15;
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#B8860B'; ctx.font = 'bold 24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText("$", 0, 2);
                ctx.fillStyle = '#000'; 
                ctx.beginPath(); ctx.fillText("$", -10, -10); ctx.fillText("$", 10, -10);
                ctx.shadowBlur = 0;
            } 
            // å°é¬¼ä»”æ®¼ (éª·é«å½¢)
            else if (hanzi === "å°é¬¼ä»”æ®¼") { 
                ctx.fillStyle = '#DDD'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#000'; 
                ctx.beginPath(); ctx.arc(-8, -4, 5, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(8, -4, 5, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(0, 5); ctx.lineTo(-3, 12); ctx.lineTo(3, 12); ctx.fill();
            } 
            // æ°´é¬¼ (æ¿•æ¼‰æ¼‰ã€æµ·è‰)
            else if (hanzi === "æ°´é¬¼") {
                ctx.fillStyle = 'rgba(0, 191, 255, 0.8)'; 
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.strokeStyle = '#006400'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(-10, -20); ctx.quadraticCurveTo(-15, -35, -5, -40); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(10, -20); ctx.quadraticCurveTo(15, -35, 5, -40); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -20); ctx.quadraticCurveTo(0, -40, 0, -45); ctx.stroke();
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                if (Math.floor(Date.now() / 200) % 2 === 0) {
                    ctx.fillStyle = '#00BFFF'; ctx.beginPath(); ctx.arc(10, 15, 3, 0, Math.PI*2); ctx.fill();
                }
            }
            // é¬–æ¯›é¬¼ (ç‚¸æ¯›) - ä¿ç•™
            else if (hanzi === "é¬–æ¯›é¬¼") {
                ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
                for(let i=0; i<360; i+=15) {
                    let angle = i * Math.PI / 180;
                    let len = radius + 5 + Math.random() * 10;
                    ctx.beginPath();
                    ctx.moveTo(Math.cos(angle)*radius, Math.sin(angle)*radius);
                    ctx.lineTo(Math.cos(angle)*len, Math.sin(angle)*len);
                    ctx.stroke();
                }
                ctx.fillStyle = '#5D4037'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(-8, -4, 4, 0, Math.PI * 2); ctx.arc(8, -4, 4, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 1, 0, Math.PI * 2); ctx.arc(8, -4, 1, 0, Math.PI * 2); ctx.fill();
            }
            // é è¨­é¬¼æ€ª (å…¶ä»–)
            else {
                ctx.shadowColor = bodyColor; ctx.shadowBlur = 15;
                ctx.fillStyle = bodyColor; ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0; 
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                
                // æ™®é€šå¯æ„›è‡‰
                ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(-8, -4, 6, 0, Math.PI * 2); ctx.arc(8, -4, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.arc(8, -4, 2, 0, Math.PI * 2); ctx.fill();
                
                // æ ¹æ“šåå­—å¾®èª¿å˜´å·´
                ctx.beginPath(); 
                if (hanzi.includes("æµ")) { // é¤“é¬¼å˜´å·´å¤§
                     ctx.fillStyle = '#000'; ctx.arc(0, 10, 8, 0, Math.PI*2); ctx.fill();
                } else if (hanzi.includes("æ­¹")) { // å£é¬¼ç”Ÿæ°£å˜´
                     ctx.moveTo(-5, 10); ctx.quadraticCurveTo(0, 5, 5, 10); ctx.stroke();
                } else { // æ™®é€šå¾®ç¬‘
                     ctx.moveTo(-8, 8); ctx.quadraticCurveTo(0, 16, 8, 8); ctx.stroke();
                }
            }
        }

        // ä¿®æ”¹ï¼šé‡ç¹ªç‚ºè¯éº—çš„ç«‹é«”ä¸‰é¢é“å£‡ (åƒè€ƒç…§ç‰‡)
        function drawAltar(ctx, x, height) {
            // ä¿®æ”¹ï¼šé“å£‡å¤§å°ç¸®å°è‡³åŸä¾†çš„å…­æˆ (0.6 * 0.6 = 0.36)
            // ä¿®æ”¹ï¼šä½ç½®ç§»è‡³å·¦å´ä¸­é–“ (å‚ç›´ç½®ä¸­)
            const scale = 0.36; 
            // ä¼°ç®—é“å£‡ç¹ªè£½é«˜åº¦ç´„ 350px (æœªç¸®æ”¾)ï¼Œç¸®æ”¾å¾Œç´„ 125pxã€‚
            // ç‚ºäº†è®“è¦–è¦ºä¸­å¿ƒåœ¨ç•«é¢ä¸­é–“ï¼Œåº•åº§ä½ç½®ç´„ç‚º height/2 + (125/2)
            const altarBaseY = height / 2 + 60; 

            ctx.save();
            // å°‡åº§æ¨™ç³»ç§»åˆ°é“å£‡ä¸­å¿ƒåº•éƒ¨
            // x æ˜¯ WALL_X (150)ï¼Œæˆ‘å€‘ç¨å¾®å¾€å·¦ç§»ä¸€é»è®“çµç•Œä¸­å¿ƒå°æº–ç‰†ç·š
            ctx.translate(x, altarBaseY); 
            
            // --- ç¸®æ”¾æ•´å€‹é“å£‡èˆ‡çµç•Œ ---
            ctx.scale(scale, scale); 

            const altarWidth = 200;
            const altarHeight = 250;

            // --- 1. å¾Œæ–¹èƒŒæ™¯æ›è»¸ (ä¸‰æ¸…é“ç¥–) ---
            ctx.save();
            ctx.translate(0, -altarHeight - 100);
            // æ›è»¸æ¡†æ¶
            ctx.fillStyle = '#4E342E'; // æ·±æœ¨è‰²
            ctx.fillRect(-120, 0, 240, 350);
            ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 4;
            ctx.strokeRect(-120, 0, 240, 350);
            
            // ç•«åƒå…§å®¹ (é‡‘è‰²èƒŒæ™¯ + ç°¡åŒ–ç¥åƒè¼ªå»“)
            ctx.fillStyle = '#FFD700'; // é‡‘è‰²ç•«å¸ƒ
            ctx.fillRect(-110, 10, 220, 330);
            
            // ç°¡åŒ–ä¸‰æ¸…ç¥åƒ (å·¦ä¸­å³)
            ctx.fillStyle = '#FFECB3'; // ç¥åƒè†šè‰²
            ctx.strokeStyle = '#FF5722'; // ç¥åƒæé‚Š
            ctx.lineWidth = 2;
            // ä¸­é–“ç¥åƒ
            ctx.beginPath(); ctx.arc(0, 100, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // é ­
            ctx.beginPath(); ctx.moveTo(-30, 130); ctx.lineTo(30, 130); ctx.lineTo(40, 250); ctx.lineTo(-40, 250); ctx.closePath(); ctx.fill(); ctx.stroke(); // èº«
            // å·¦å´ç¥åƒ
            ctx.beginPath(); ctx.arc(-70, 120, 25, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-95, 145); ctx.lineTo(-45, 145); ctx.lineTo(-35, 240); ctx.lineTo(-105, 240); ctx.closePath(); ctx.fill(); ctx.stroke();
            // å³å´ç¥åƒ
            ctx.beginPath(); ctx.arc(70, 120, 25, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(45, 145); ctx.lineTo(95, 145); ctx.lineTo(105, 240); ctx.lineTo(35, 240); ctx.closePath(); ctx.fill(); ctx.stroke();
            ctx.restore();

            // --- 2. ç«‹é«”ä¾›æ¡Œ (ä¸‰å±¤çµæ§‹) ---
            // ä¸Šå±¤ä¾›æ¡Œ (ä¸»æ¡Œ)
            ctx.fillStyle = '#8D6E63'; // æœ¨æ¡Œè‰²
            ctx.fillRect(-100, -altarHeight, 200, 40); // æ¡Œé¢
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 3;
            ctx.strokeRect(-100, -altarHeight, 200, 40);
            
            // æ¡Œè£™ (ç´…è‰²åˆºç¹¡)
            ctx.fillStyle = '#C62828';
            ctx.fillRect(-100, -altarHeight + 40, 200, 120);
            // åˆºç¹¡åœ–æ¡ˆ (ç°¡åŒ–ç‚ºé‡‘è‰²ç´‹è·¯)
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2;
            ctx.beginPath();
            for(let i=-90; i<90; i+=20) {
                ctx.moveTo(i, -altarHeight + 50);
                ctx.quadraticCurveTo(i+10, -altarHeight + 100, i, -altarHeight + 150);
            }
            ctx.stroke();
            // å…«å¦åœ–æ¡ˆ (ç°¡åŒ–)
            ctx.beginPath(); ctx.arc(0, -altarHeight + 100, 25, 0, Math.PI*2);
            ctx.fillStyle = '#FFD700'; ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(0, -altarHeight + 100, 10, 0, Math.PI); ctx.fill();
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(0, -altarHeight + 100, 10, Math.PI, 0); ctx.fill();

            // ä¸‹å±¤ä¾›æ¡Œ (è¼ƒå¯¬)
            ctx.fillStyle = '#6D4C41';
            ctx.fillRect(-120, -altarHeight + 160, 240, 40);
            ctx.strokeRect(-120, -altarHeight + 160, 240, 40);
            // ä¸‹å±¤æ¡Œè£™
            ctx.fillStyle = '#B71C1C';
            ctx.fillRect(-120, -altarHeight + 200, 240, 80);
            ctx.strokeRect(-120, -altarHeight + 200, 240, 80);

            // --- 3. ä¾›å“èˆ‡æ³•å™¨ ---
            // é¦™çˆ (ä¸»æ¡Œä¸­å¤®)
            ctx.fillStyle = '#D4AF37'; // éŠ…è‰²
            ctx.beginPath(); ctx.arc(0, -altarHeight - 15, 20, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // çˆèº«
            ctx.fillRect(-25, -altarHeight - 15, 50, 5); // çˆå£
            // é¦™ç…™
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)'; ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-5, -altarHeight - 20); ctx.quadraticCurveTo(0, -altarHeight - 60, 5, -altarHeight - 40);
            ctx.moveTo(5, -altarHeight - 20); ctx.quadraticCurveTo(0, -altarHeight - 60, -5, -altarHeight - 40);
            ctx.stroke();

            // ç‡­å° (ä¸»æ¡Œå…©å´)
            function drawCandle(cx, cy) {
                ctx.fillStyle = '#D32F2F'; ctx.fillRect(cx-5, cy-40, 10, 40); // ç‡­èº«
                ctx.fillStyle = '#FFD700'; ctx.fillRect(cx-8, cy-5, 16, 5); // åº•åº§
                // ç‡­ç«
                ctx.fillStyle = '#FF5722';
                ctx.beginPath(); ctx.moveTo(cx, cy-40); ctx.quadraticCurveTo(cx+5, cy-55, cx, cy-60); ctx.quadraticCurveTo(cx-5, cy-55, cx, cy-40); ctx.fill();
                ctx.shadowColor = '#FF5722'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(cx, cy-50, 5, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
            drawCandle(-80, -altarHeight);
            drawCandle(80, -altarHeight);

            // è²¢å“ (ä¸‹å±¤æ¡Œ) - ç°¡åŒ–ç‚ºå¹¾å€‹ç›¤å­å’Œæ°´æœ
            ctx.fillStyle = '#FFF'; ctx.strokeStyle='#CCC';
            ctx.beginPath(); ctx.ellipse(-60, -altarHeight + 170, 25, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // å·¦ç›¤
            ctx.beginPath(); ctx.ellipse(60, -altarHeight + 170, 25, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // å³ç›¤
            // æ°´æœ
            ctx.fillStyle = '#FF9800'; ctx.beginPath(); ctx.arc(-60, -altarHeight + 165, 10, 0, Math.PI*2); ctx.fill(); // æ©˜å­
            ctx.fillStyle = '#D32F2F'; ctx.beginPath(); ctx.arc(60, -altarHeight + 165, 10, 0, Math.PI*2); ctx.fill(); // è˜‹æœ

            // --- 4. å…©å´è£é£¾ ---
            // å·¦å´æ——å¹Ÿ
            ctx.save();
            ctx.translate(-160, -altarHeight);
            ctx.fillStyle = '#D32F2F'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-40, 20); ctx.lineTo(0, 150); ctx.closePath(); ctx.fill();
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.stroke();
            ctx.restore();
            // å³å´æ——å¹Ÿ
            ctx.save();
            ctx.translate(160, -altarHeight);
            ctx.fillStyle = '#D32F2F'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(40, 20); ctx.lineTo(0, 150); ctx.closePath(); ctx.fill();
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.stroke();
            ctx.restore();
            
            // --- 5. é˜²è­·ç½© (åŸæœ¬åœ¨ restore ä¹‹å¾Œï¼Œç¾åœ¨è¦åœ¨ restore ä¹‹å‰ç¹ªè£½ä»¥å— scale å½±éŸ¿) ---
            const barrierOpacity = 0.3 + Math.sin(frames * 0.05) * 0.1;
            
            // ä¿®æ”¹ï¼šæ“´å¤§çµç•Œç¯„åœä»¥åŒ…ä½é“å£«
            const barrierRadiusX = 320; 
            const barrierRadiusY = altarHeight/2 + 50;
            const barrierCenterY = -altarHeight/2;

            // ä¿®æ”¹ï¼šä½¿ç”¨å¾‘å‘æ¼¸å±¤å–ä»£å¯¦å¿ƒå¡«å……ï¼Œè®“ä¸­å¿ƒ(é“å£«æ‰€åœ¨è™•)ä¿æŒæ¸…æ™°ï¼Œåªæœ‰é‚Šç·£ç™¼å…‰
            // å‰µå»ºä¸€å€‹æ©¢åœ“å½¢çš„æ¼¸å±¤æ•ˆæœæ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡ç”¨è¿‘ä¼¼çš„å¾‘å‘æ¼¸å±¤ï¼Œé‡é»æ˜¯ä¸­å¿ƒé€æ˜
            const barrierGradient = ctx.createRadialGradient(0, barrierCenterY, barrierRadiusX * 0.2, 0, barrierCenterY, barrierRadiusX);
            barrierGradient.addColorStop(0, 'rgba(255, 215, 0, 0)'); // ä¸­å¿ƒå®Œå…¨é€æ˜
            barrierGradient.addColorStop(0.7, 'rgba(255, 215, 0, 0.05)'); // ä¸­é–“å¾®äº®
            barrierGradient.addColorStop(0.95, `rgba(255, 215, 0, ${barrierOpacity * 0.4})`); // é‚Šç·£äº®èµ·
            barrierGradient.addColorStop(1, `rgba(255, 215, 0, 0)`);

            ctx.fillStyle = barrierGradient;
            ctx.strokeStyle = `rgba(255, 255, 0, ${barrierOpacity * 0.8})`; // é‚Šç•Œå…‰
            ctx.lineWidth = 4;
            ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 15; // ç¨å¾®é™ä½æ¨¡ç³Šï¼Œè®“ç·šæ¢æ›´ä¿è½
            
            ctx.beginPath();
            // ç’°ç¹é“å£‡çš„æ©¢åœ“å½¢é˜²è­·ç½©
            ctx.ellipse(0, barrierCenterY, barrierRadiusX, barrierRadiusY, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
            ctx.shadowBlur = 0;

            // --- 6. æ¼‚æµ®ç¬¦ä»¤ (æ²¿è‘—é˜²è­·ç½©é‚Šç·£) ---
            const talismanSpacing = 1.0; // å¼§åº¦é–“éš”
            const offset = (frames * 0.02) % (Math.PI*2); 
            
            for (let angle = 0; angle < Math.PI * 2; angle += talismanSpacing) {
                let drawAngle = angle + offset;
                // ç¬¦ä»¤è»Œé“
                const tx = Math.cos(drawAngle) * barrierRadiusX;
                const ty = barrierCenterY + Math.sin(drawAngle) * barrierRadiusY;
                
                ctx.save();
                ctx.translate(tx, ty);
                ctx.rotate(drawAngle + Math.PI/2); // ç¬¦ä»¤æœå‘åˆ‡ç·šæ–¹å‘
                
                // ç¹ªè£½é»ƒåº•ç´…å­—ã€Œä»¤ã€ç¬¦
                ctx.fillStyle = '#FDD835'; 
                ctx.fillRect(-10, -15, 20, 30);
                ctx.strokeStyle = '#B8860B'; 
                ctx.lineWidth = 1;
                ctx.strokeRect(-10, -15, 20, 30);
                ctx.fillStyle = '#D50000'; 
                ctx.font = 'bold 16px "KaiTi", "BiauKai", serif'; 
                ctx.textAlign = 'center'; 
                ctx.textBaseline = 'middle';
                ctx.fillText("ä»¤", 0, 2);
                ctx.restore();
            }

            ctx.restore(); // çµæŸ scale å’Œ translate
        }

        function drawRooster(ctx, x, y, isAwake) {
            ctx.save();
            ctx.translate(x, y);
            
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#000'; ctx.shadowBlur = 5;
            ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = '#ddd';
            ctx.beginPath(); ctx.ellipse(-8, 8, 12, 8, 0.5, 0, Math.PI*2); ctx.fill();
            
            ctx.fillStyle = '#D32F2F';
            ctx.beginPath(); ctx.arc(0, -22, 6, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(-7, -18, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(7, -18, 5, 0, Math.PI*2); ctx.fill();
            
            ctx.strokeStyle = '#FF9800'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-5, 22); ctx.lineTo(-5, 30); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(5, 22); ctx.lineTo(5, 30); ctx.stroke();

            if (!isAwake) {
                if (frames % 120 < 60) {
                    ctx.fillStyle = '#bbb';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText("Z", 15, -25);
                }
                if (frames % 120 > 30 && frames % 120 < 90) {
                      ctx.fillStyle = '#bbb';
                      ctx.font = 'bold 12px Arial';
                      ctx.fillText("z", 22, -35);
                }
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(2, -5); ctx.lineTo(10, -5); ctx.stroke();
            } else {
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(5, -5, 2, 0, Math.PI*2); ctx.fill();
                
                ctx.fillStyle = '#FF9800';
                ctx.beginPath(); ctx.moveTo(12, -2); ctx.lineTo(25, -8); ctx.lineTo(25, 2); ctx.fill();
                
                if (frames % 30 < 15) {
                    ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(25, -2, 10, -0.5, 0.5); ctx.stroke();
                }
                if (frames % 30 < 25) {
                    ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(25, -2, 15, -0.5, 0.5); ctx.stroke();
                }
            }
            ctx.restore();
        }

        // é‡æ–°è£œå› drawSky å‡½æ•¸
        function drawSky(ctx, width, height, progress) {
            // æœˆäº®è»Œè·¡èµ·é»æ”¹ç‚ºé“å£«ä½ç½®ä¸Šæ–¹
            const startX = 60; 
            const endX = width - 50;
            const currentX = startX + (endX - startX) * progress;
            
            const baseY = 180;
            const arcHeight = 120;
            const skyY = baseY - Math.sin(progress * Math.PI) * arcHeight;

            if (progress < 0.98) {
                ctx.save();
                ctx.translate(currentX, skyY);
                ctx.fillStyle = '#FFFDE7';
                ctx.shadowColor = '#FFF59D'; ctx.shadowBlur = 20;
                ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#1a1a1a';
                ctx.shadowBlur = 0;
                ctx.beginPath(); ctx.arc(-10, -5, 25, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            }

            if (progress > 0.9) {
                const sunRiseProgress = (progress - 0.9) * 10; 
                
                // å¤ªé™½å‡èµ·ä½ç½®
                const sunY = (height * 0.6) - ((height * 0.4) * sunRiseProgress);
                const sunX = 60; 
                
                // ä¿®æ”¹ï¼šèª¿æ•´èƒŒæ™¯å…‰æšˆå¼·åº¦ï¼Œè®“å®ƒæ›´æŸ”å’Œï¼Œä¸è¦å¤ªé»ƒå¤ªäº®
                const gradient = ctx.createRadialGradient(sunX, sunY, 10, sunX, sunY, 300);
                gradient.addColorStop(0, `rgba(255, 69, 0, ${sunRiseProgress * 0.6})`); // é™ä½ä¸­å¿ƒé€æ˜åº¦
                gradient.addColorStop(1, 'rgba(255, 69, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                
                // ä¿®æ”¹ï¼šå¤ªé™½æœ¬é«”é¡è‰²èˆ‡é‚Šæ¡†ï¼Œä½¿å…¶æ›´é¡¯çœ¼
                // ä½¿ç”¨äº®æ©™è‰²æ ¸å¿ƒï¼Œç´…è‰²é‚Šç·£ï¼Œæ¸›å°‘æ¨¡ç³Š
                ctx.fillStyle = '#FF3300'; // æ›´æ·±ä¸€é»çš„æ©˜ç´…ï¼Œå°æ¯”åº¦æ›´é«˜
                ctx.strokeStyle = '#FFD700'; // é‡‘è‰²é‚Šæ¡†
                ctx.lineWidth = 3;
                
                ctx.shadowColor = '#FF8C00'; ctx.shadowBlur = 10; // é™ä½æ¨¡ç³ŠåŠå¾‘ï¼Œè®“è¼ªå»“æ›´æ¸…æ™°
                ctx.globalAlpha = sunRiseProgress;
                
                ctx.beginPath(); ctx.arc(sunX, sunY, 40, 0, Math.PI*2); 
                ctx.fill();
                ctx.shadowBlur = 0; // é‚Šæ¡†ä¸æ¨¡ç³Š
                ctx.stroke();
                
                ctx.globalAlpha = 1.0;
            }
        }

        function playRoosterCrow() {
            if (!isMuted) {
                roosterAudio.play().catch(error => {
                    console.log("Audio play failed, falling back to speech synthesis:", error);
                    fallbackSpeechCrow();
                });
            }
        }

        function fallbackSpeechCrow() {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance("KÃº-kÃº-kÃº------!");
                utterance.lang = 'zh-TW'; 
                utterance.pitch = 1.5; 
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        document.getElementById('soundUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const statusDiv = document.getElementById('audioStatus');
            if (file) {
                const objectURL = URL.createObjectURL(file);
                roosterAudio.src = objectURL;
                statusDiv.innerText = `å·²è¼‰å…¥: ${file.name}`;
                statusDiv.className = 'audio-status ok';
            }
        });

        roosterAudio.addEventListener('error', () => {
             const statusDiv = document.getElementById('audioStatus');
             statusDiv.innerText = "âš ï¸ æœªåµæ¸¬åˆ°é è¨­éŸ³æ•ˆæª”ï¼Œè«‹ç¢ºèª 'å¤§é›é›å«.mp3' æ˜¯å¦å­˜åœ¨ï¼Œæˆ–æ‰‹å‹•é¸æ“‡æª”æ¡ˆã€‚";
             statusDiv.className = 'audio-status error';
        });

        roosterAudio.addEventListener('canplaythrough', () => {
             const statusDiv = document.getElementById('audioStatus');
             if(statusDiv.innerText === "") { 
                 statusDiv.innerText = "âœ… é è¨­éŸ³æ•ˆè¼‰å…¥æˆåŠŸ";
                 statusDiv.className = 'audio-status ok';
             }
        });

        // --- é¡åˆ¥å®šç¾© (ä¿æŒåŸæ¨£) ---
        class Taoist {
            constructor() {
                this.x = 60; // ä¿®æ”¹ï¼šé“å£«ç§»å›æœ€å·¦å´
                this.y = canvas.height / 2 + 60; // é“å£«é«˜åº¦
                this.targetAngle = 0;
                this.currentAngle = 0;
                this.radius = 35;
            }
            update() {
                let diff = this.targetAngle - this.currentAngle;
                while (diff < -Math.PI) diff += Math.PI * 2;
                while (diff > Math.PI) diff -= Math.PI * 2;
                this.currentAngle += diff * 0.1;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                this.drawItems();
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath(); ctx.ellipse(0, 40, 25, 8, 0, 0, Math.PI * 2); ctx.fill();
                ctx.rotate(this.currentAngle * 0.1); 
                // é“å£«ç¹ªè£½ (ä¿ç•™åŸå§‹ç¹ªåœ–æŒ‡ä»¤)
                ctx.fillStyle = '#FFC107'; 
                ctx.beginPath();
                ctx.moveTo(-20, 10); ctx.lineTo(20, 10);
                ctx.lineTo(30, 45); ctx.lineTo(-30, 45);
                ctx.closePath(); ctx.fill();
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#333';
                ctx.beginPath(); ctx.moveTo(-20, 10); ctx.lineTo(-5, 45); ctx.lineTo(-28, 45); ctx.fill(); 
                ctx.beginPath(); ctx.moveTo(20, 10); ctx.lineTo(5, 45); ctx.lineTo(28, 45); ctx.fill(); 
                ctx.beginPath(); ctx.moveTo(0, 10); ctx.lineTo(0, 45); ctx.stroke();
                ctx.fillStyle = '#FFE0B2'; 
                ctx.beginPath(); ctx.arc(0, -5, 22, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(-8, -8, 3, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(8, -8, 3, 0, Math.PI * 2); ctx.fill();
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(-12, -14); ctx.lineTo(-4, -10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(12, -14); ctx.lineTo(4, -10); ctx.stroke();
                ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.moveTo(-2, 2); ctx.lineTo(-10, 6); 
                ctx.moveTo(2, 2); ctx.lineTo(10, 6);    
                ctx.moveTo(0, 4); ctx.lineTo(0, 10);    
                ctx.stroke();
                ctx.fillStyle = '#222';
                ctx.fillRect(-24, -35, 48, 20); 
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(-24, -17, 48, 4);
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.arc(0, -25, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(0, -25, 6, -Math.PI/2, Math.PI/2); ctx.fill();
                ctx.beginPath(); ctx.arc(0, -28, 2, 0, Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
                ctx.beginPath(); ctx.arc(0, -22, 2, 0, Math.PI*2); ctx.fillStyle='#FFF'; ctx.fill();
                ctx.fillStyle = '#FFE0B2';
                ctx.beginPath(); ctx.arc(-20, 20, 6, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.arc(20, 20, 6, 0, Math.PI*2); ctx.fill(); 
                ctx.save();
                ctx.translate(20, 20);
                ctx.rotate(Math.PI / 4);
                // ä¿®æ”¹ï¼šé“å£«èƒŒå¾Œçš„æ¡ƒæœ¨åŠé¡è‰²æ”¹ç‚ºç´…è‰²
                ctx.fillStyle = '#D32F2F'; // ç´…è‰²åŠèº«
                ctx.fillRect(-2, -20, 4, 30); 
                ctx.fillStyle = '#B71C1C'; // æ·±ç´…è‰²è­·æ‰‹
                ctx.fillRect(-5, 0, 10, 2); 
                ctx.restore();
                ctx.restore();
            }
            drawItems() {
                // ä¿®æ”¹ï¼šå¦‚æœæŒæœ‰ç¬¦ä»¤ï¼Œç¹ªè£½é»ƒç´™ç´…å­—ã€Œä»¤ã€
                if (items.talisman.count > 0) {
                    ctx.save();
                    ctx.translate(0, -65 + Math.sin(frames * 0.08) * 3);
                    // ç¬¦ç´™èƒŒæ™¯
                    ctx.fillStyle = '#FDD835'; 
                    // ctx.shadowColor = '#FDD835'; ctx.shadowBlur = 10; // é“å£«é“å…·ä¿æŒä¸€é»å…‰æšˆä»¥ç¤ºå€åˆ¥
                    ctx.fillRect(-10, -15, 20, 30);
                    ctx.strokeStyle = '#B8860B'; 
                    ctx.lineWidth = 1;
                    ctx.strokeRect(-10, -15, 20, 30);
                    // ctx.shadowBlur = 0;
                    // ç´…è‰²ã€Œä»¤ã€å­—
                    ctx.fillStyle = '#D50000'; 
                    ctx.font = 'bold 16px "KaiTi", "BiauKai", serif'; 
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle';
                    ctx.fillText("ä»¤", 0, 2);
                    ctx.restore();
                }

                // ä¿®æ”¹ï¼šé“å£«é ­ä¸Šçš„æ¡ƒæœ¨åŠåœ–ç¤ºä¹Ÿæ”¹ç‚ºç´…è‰²
                if (items.sword.count > 0) this.drawItemIcon(-45, -20, '#D32F2F', 'åŠ');
                if (items.bell.count > 0) this.drawItemIcon(45, -20, '#C0C0C0', 'éˆƒ');
            }
            drawItemIcon(dx, dy, color, label) {
                ctx.save();
                ctx.translate(dx, dy + Math.sin(frames * 0.08) * 3);
                // ctx.shadowColor = color; ctx.shadowBlur = 10;
                ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.fill();
                // ctx.shadowBlur = 0; 
                ctx.fillStyle = '#000'; 
                ctx.font = 'bold 12px Microsoft JhengHei'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; 
                ctx.fillText(label, 0, 1);
                ctx.restore();
            }
            shootHoming(targetGhost, type) {
                // ç”¢ç”Ÿè¿½è¹¤æŠ•å°„ç‰©
                const startX = this.x + 20;
                const startY = this.y;
                const angle = Math.atan2(targetGhost.y - startY, targetGhost.x - startX);
                
                // åˆå§‹é€Ÿåº¦æ–¹å‘ (ä¿®æ­£ï¼šæ‰“å­—æ”»æ“Š 'normal' é€Ÿåº¦åŠ å¿«ï¼Œé¿å…ç­‰å¾…éä¹…)
                const speed = (type === 'normal') ? 30 : 15; 
                const velocity = { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed };
                
                // å»ºç«‹æŒ‡å‘ç›®æ¨™çš„æŠ•å°„ç‰©
                projectiles.push(new Projectile(startX, startY, velocity, angle, type, targetGhost));
            }
            // shootAt å·²ç§»é™¤ï¼Œæ”¹ç”¨ shootHoming çµ±ä¸€è™•ç†
        }

        class Ghost {
            constructor(yPosition, data, colorOverride) {
                this.hanzi = data.hanzi;
                this.tailo = (romanizationMode === 'poj') ? data.poj : data.tailo; 
                this.numeric = data.numeric || [];
                this.score = data.score || 50;
                this.radius = 25; 
                this.x = canvas.width + 100;
                this.y = yPosition; 
                let baseSpeed = 1.0;
                if (difficulty === 'B') baseSpeed = 1.5;
                if (difficulty === 'C') baseSpeed = 2.2;
                this.speed = (baseSpeed + Math.random() * 0.5) * 0.25; 
                this.maxHp = 1; this.hp = 1; this.damage = 10;
                
                // å¦‚æœæœ‰æŒ‡å®šé¡è‰²ï¼ˆå¾é è¦½ä¾†çš„ï¼‰ï¼Œå°±ç”¨æŒ‡å®šçš„ï¼Œå¦å‰‡éš¨æ©Ÿ
                if (colorOverride) {
                    this.bodyColor = colorOverride;
                } else {
                    const colors = ['#4FC3F7', '#795548', '#D32F2F', '#9C27B0', '#FFD700', '#555'];
                    this.bodyColor = colors[Math.floor(Math.random() * colors.length)];
                }
                
                this.isTargetedByItem = false; // æ–°å¢ï¼šæ˜¯å¦è¢«é“å…·é–å®š
                this.pendingDeath = false; // æ–°å¢ï¼šæ˜¯å¦å·²è¢«æ–‡å­—æ“Šä¸­ (ç­‰å¾…å…‰æŸåˆ°é”)
            }
            update() {
                // ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„é˜²ç·šè®Šæ•¸ DEFENSE_LINE_X
                if (this.x > DEFENSE_LINE_X) {
                    this.x -= this.speed;
                } else {
                    // åˆ°é”é˜²ç·šï¼Œé–‹å§‹æ”»æ“Š
                    if (frames % 60 === 0) {
                        takeDamage(this.damage);
                        createParticles(this.x - this.radius, this.y, '#FF0000', 3);
                    }
                }
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // çµ±ä¸€å‘¼å«ç¹ªåœ–å‡½å¼
                drawGhostAppearance(ctx, this.hanzi, this.bodyColor, this.radius);
                
                // æ–‡å­—æé‚Šå¢åŠ å°æ¯”åº¦ (å–ä»£é»‘æ¡†)
                ctx.textAlign = 'center';
                
                // æ¼¢å­—
                ctx.font = 'bold 20px Microsoft JhengHei';
                ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.strokeText(this.hanzi, 0, -40); // æé‚Š
                ctx.fillStyle = '#FFD700'; ctx.fillText(this.hanzi, 0, -40); // å¡«å……

                if (difficulty !== 'C') {
                    ctx.font = '14px Courier New';
                    // ç¾…é¦¬æ‹¼éŸ³
                    ctx.strokeStyle = '#000'; ctx.lineWidth = 4; ctx.strokeText(this.tailo, 0, 50); // æé‚Š
                    ctx.fillStyle = '#00FF00'; 
                    let userInput = gameInput.value.toLowerCase().trim();
                    let display = this.tailo.normalize('NFC');
                    if (userInput.length > 0 && (processInput(display).startsWith(userInput) || display.toLowerCase().startsWith(userInput))) {
                        ctx.fillStyle = '#FFFF00'; 
                    }
                    ctx.fillText(this.tailo, 0, 50); // å¡«å……
                }
                ctx.restore();
            }
        }

        class Projectile {
            constructor(x, y, velocity, angle, type, target) {
                this.x = x; this.y = y; this.velocity = velocity; this.angle = angle;
                this.markedForDeletion = false; this.life = 20; 
                this.type = type || 'normal'; // normal, talisman, sword, bell
                this.target = target; // ç›®æ¨™é¬¼æ€ªç‰©ä»¶
                this.speed = 10; // é£›è¡Œé€Ÿåº¦ (è¼ƒæ…¢)
            }
            update() {
                // è¨˜éŒ„ç›®æ¨™æœ€å¾Œçš„ä½ç½®ï¼Œå¦‚æœç›®æ¨™æ­»äº†ï¼Œå°±é£›å¾€æœ€å¾Œå·²çŸ¥ä½ç½®
                let targetX, targetY;
                
                if (this.target) {
                    // å¦‚æœç›®æ¨™é‚„æ´»è‘—ï¼ŒæŒçºŒæ›´æ–°ç›®æ¨™ä½ç½®
                    if (this.target.hp > 0) {
                        this.lastKnownX = this.target.x;
                        this.lastKnownY = this.target.y;
                    }
                    // å¦‚æœé‚„æ²’æœ‰ç´€éŒ„éä½ç½®(å‰›ç”Ÿæˆ)ï¼Œå°±å…ˆç”¨ç›®æ¨™ç•¶å‰ä½ç½®
                    if (this.lastKnownX === undefined) {
                        this.lastKnownX = this.target.x;
                        this.lastKnownY = this.target.y;
                    }
                    
                    targetX = this.lastKnownX;
                    targetY = this.lastKnownY;
                }

                const dx = targetX - this.x;
                const dy = targetY - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 20) { // æ“Šä¸­åˆ¤å®šè·é›¢
                    // åªæœ‰ç•¶ç›®æ¨™é‚„æ´»è‘—æ™‚æ‰åŸ·è¡Œæ“Šæ®ºé‚è¼¯
                    if (this.target && this.target.hp > 0) {
                        killGhost(this.target, this.type);
                    } else {
                        // å¦‚æœç›®æ¨™å·²ç¶“æ­»äº†(è¢«æ‰“å­—æ®ºæ­»)ï¼Œé€™è£¡åªè² è²¬ç”¢ç”Ÿçˆ†ç‚¸ç²’å­æ•ˆæœ
                        createParticles(this.x, this.y, '#FFFF00', 5);
                    }
                    this.markedForDeletion = true;
                } else {
                    // å°å¼•é£›è¡Œ
                    this.angle = Math.atan2(dy, dx);
                    this.speed = (this.type === 'normal') ? 25 : 15; 
                    this.velocity.x = Math.cos(this.angle) * this.speed;
                    this.velocity.y = Math.sin(this.angle) * this.speed;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                }
            }
            draw() {
                ctx.save(); 
                ctx.translate(this.x, this.y); 
                
                if (this.type === 'talisman') {
                    // ç¬¦ä»¤æŠ•å°„ç‰©ï¼šæŒ‡å‘ç›®æ¨™æ–¹å‘ï¼Œä¸æ—‹è½‰
                    ctx.rotate(this.angle);
                    ctx.fillStyle = '#FDD835'; 
                    ctx.fillRect(-15, -10, 30, 20); 
                    ctx.strokeStyle = '#B8860B'; ctx.strokeRect(-15, -10, 30, 20);
                    ctx.fillStyle = '#D50000'; ctx.font = 'bold 12px serif'; 
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText("ä»¤", 0, 0);
                } else if (this.type === 'sword') {
                    // æ¡ƒæœ¨åŠæŠ•å°„ç‰©ï¼šæŒ‡å‘ç›®æ¨™æ–¹å‘ï¼Œä¸æ—‹è½‰
                    ctx.rotate(this.angle);
                    // ç¹ªè£½æ°´å¹³å‘å³çš„åŠ (åŠå°–æœå³)
                    ctx.fillStyle = '#D32F2F'; // ç´…è‰²åŠèº«
                    ctx.beginPath();
                    ctx.moveTo(15, 0); 
                    ctx.lineTo(-10, 4); 
                    ctx.lineTo(-10, -4); 
                    ctx.fill();
                    // åŠæŸ„/è­·æ‰‹
                    ctx.strokeStyle = '#B71C1C';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(-10, -6); ctx.lineTo(-10, 6); // è­·æ‰‹
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-10, 0); ctx.lineTo(-18, 0); // æ¡æŠŠ
                    ctx.stroke();
                } else if (this.type === 'bell') {
                    // å¸«å…¬éˆƒæŠ•å°„ç‰©ï¼šè²æ³¢æ“´æ•£
                    // é€™è£¡ä¸æ—‹è½‰ï¼Œè€Œæ˜¯è®“è²æ³¢å‘ç›®æ¨™æ–¹å‘æ“´æ•£
                    ctx.rotate(this.angle);
                    ctx.strokeStyle = `rgba(255, 215, 0, ${0.5 + Math.sin(frames * 0.5) * 0.5})`;
                    ctx.lineWidth = 3;
                    ctx.beginPath(); ctx.arc(0, 0, 10, -0.5, 0.5); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, 0, 20, -0.5, 0.5); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, 0, 30, -0.5, 0.5); ctx.stroke();
                } else {
                    // æ™®é€šæ”»æ“Šï¼šé»ƒè‰²ç¬¦ç´™ "æ••"
                    ctx.rotate(this.angle);
                    ctx.fillStyle = '#FFFF00'; ctx.fillRect(-20, -5, 40, 10); 
                    ctx.strokeStyle = '#FF0000'; ctx.strokeRect(-20, -5, 40, 10);
                    ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 10;
                    ctx.fillStyle = '#FF0000'; ctx.font = '8px Arial'; ctx.fillText("æ••", -5, 3);
                }
                
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10; this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
            draw() {
                ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function initGame() {
            taoist = new Taoist();
            ghosts = []; projectiles = []; particles = []; mistakes = [];
            wallHp = wallMaxHp; score = 0; killCount = 0; frames = 0;
            timeElapsed = 0; isPaused = false;
            gameInput.value = ""; gameInput.focus();
            items.talisman.count = 3; items.sword.count = 2; items.bell.count = 1;
            
            // é‡ç½® Shuffle Bags
            basicGhostBag = [];
            advancedGhostBag = [];
            lastGhostWasAdvanced = false;
            
            nextGhostData = getRandomGhostData();
            nextGhostColor = getRandomColor(); // åˆå§‹åŒ–é¡è‰²
            
            nextSpawnTime = 0; // Reset spawn timer
            
            document.getElementById('leftControls').style.display = 'flex';
            updateUI();
        }
        
        // æ´—ç‰Œæ¼”ç®—æ³•
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // å¾ Bag ç²å–ä¸‹ä¸€å€‹åŸºç¤é¬¼
        function getNextBasicGhost() {
            if (basicGhostBag.length === 0) {
                basicGhostBag = [...vocabBasic];
                shuffleArray(basicGhostBag);
            }
            return basicGhostBag.pop();
        }

        // å¾ Bag ç²å–ä¸‹ä¸€å€‹é€²éšé¬¼
        function getNextAdvancedGhost() {
            if (advancedGhostBag.length === 0) {
                advancedGhostBag = [...vocabAdvanced];
                shuffleArray(advancedGhostBag);
            }
            return advancedGhostBag.pop();
        }
        
        // ä¿®æ”¹å¾Œçš„ç”Ÿæˆé‚è¼¯ï¼šä¸‰éšæ®µåˆ¶ + å¹³è¡¡èª¿æ•´
        function getRandomGhostData() {
            const progress = timeElapsed / GAME_DURATION_SEC;
            let spawnAdvanced = false;
            
            // 2/3 æ©Ÿç‡å‡ºåŸºç¤ï¼Œ1/3 æ©Ÿç‡å‡ºé€²éš
            const rand = Math.random();
            
            // éšæ®µ 1: 0% ~ 20% (ç´”åŸºç¤)
            if (progress < 0.2) {
                spawnAdvanced = false;
            } 
            // éšæ®µ 2 & 3: çµ±ä¸€æ©Ÿç‡ (0.33)
            else {
                spawnAdvanced = rand < 0.33;
            }

            // å¼·åˆ¶å†·å»ï¼šå¦‚æœä¸Šä¸€æ¬¡æ˜¯ä¿—è«ºï¼Œé€™æ¬¡å¼·åˆ¶å‡ºåŸºç¤é¬¼
            if (lastGhostWasAdvanced) {
                spawnAdvanced = false;
            }

            if (spawnAdvanced) {
                lastGhostWasAdvanced = true;
                return getNextAdvancedGhost(); // ä½¿ç”¨ä¸é‡è¤‡æŠ½é¡Œ
            } else {
                lastGhostWasAdvanced = false;
                return getNextBasicGhost(); // ä½¿ç”¨ä¸é‡è¤‡æŠ½é¡Œ
            }
        }

        function togglePause() {
            if (gameState !== 'PLAYING') return;
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            const pauseScreen = document.getElementById('screen-paused');
            if (isPaused) { 
                pauseBtn.innerText = "â–¶"; 
                pauseScreen.classList.remove('hidden'); 
            } 
            else { 
                pauseBtn.innerText = "â¸"; 
                pauseScreen.classList.add('hidden'); 
                gameInput.focus(); 
                // animate(); // å·²ä¿®æ­£ï¼šç§»é™¤é€™è£¡çš„ animate() å‘¼å«
            }
        }
        
        function quitGame() {
            document.getElementById('screen-paused').classList.add('hidden');
            document.getElementById('leftControls').style.display = 'none';
            document.getElementById('screen-home').classList.remove('hidden');
            gameState = 'HOME'; isPaused = false;
            // åœæ­¢ BGM (Context æš«åœ)
            if(audioCtx) audioCtx.suspend();
            hasStartedGame = false;
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            if (isMuted) { btn.innerText = "ğŸ”‡"; btn.classList.add('active'); } 
            else { btn.innerText = "ğŸ”Š"; btn.classList.remove('active'); }
        }

        function updateUI() {
            const hpPercent = (wallHp / wallMaxHp) * 100;
            document.getElementById('wallHpBar').style.width = hpPercent + '%';
            document.getElementById('wallHpText').innerText = `é“å£‡éˆåŠ›: ${Math.floor(hpPercent)}%`;
            document.getElementById('scoreDisplay').innerText = `åŠŸå¾·å€¼: ${score} | é€£æ–¬: ${killCount}`;
            document.getElementById('playerNameDisplay').innerText = `${playerName} é“å£«`;
            updateItemSlot('item-talisman', 'count-talisman', items.talisman);
            updateItemSlot('item-sword', 'count-sword', items.sword);
            updateItemSlot('item-bell', 'count-bell', items.bell);
        }

        function updateItemSlot(slotId, countId, item) {
            const slotEl = document.getElementById(slotId);
            const countEl = document.getElementById(countId);
            countEl.innerText = item.count;
            if (item.count > 0) slotEl.classList.add('active'); else slotEl.classList.remove('active');
        }

        function spawnGhost() {
            let baseRate = 420;
            if (difficulty === 'B') baseRate = 300;
            if (difficulty === 'C') baseRate = 210;
            let speedUp = Math.floor(score / 300) * 20;
            let currentSpawnRate = Math.max(60, baseRate - speedUp);
            if (frames >= nextSpawnTime) {
                const availableLanes = lanes.filter(laneY => {
                    const ghostInLane = ghosts.filter(g => Math.abs(g.y - laneY) < 10);
                    if (ghostInLane.length === 0) return true;
                    const rightmostGhost = ghostInLane.reduce((prev, curr) => (prev.x > curr.x) ? prev : curr);
                    return rightmostGhost.x < canvas.width - 150; 
                });
                if (availableLanes.length > 0) {
                    const randomLaneY = availableLanes[Math.floor(Math.random() * availableLanes.length)];
                    // ä½¿ç”¨å…¨åŸŸè®Šæ•¸ nextGhostColor ç”Ÿæˆé¬¼æ€ª
                    ghosts.push(new Ghost(randomLaneY, nextGhostData, nextGhostColor));
                    nextGhostData = getRandomGhostData();
                    nextGhostColor = getRandomColor(); // æ›´æ–°é¡è‰²
                    nextSpawnTime = frames + currentSpawnRate;
                } else nextSpawnTime = frames + 30;
            }
        }
        
        function drawNextGhostPreview() {
            if (!nextGhostData) return;
            const x = 80; // å›ºå®šåœ¨å·¦å´ (é“å£‡å·¦å´)
            // ä¿®æ”¹ï¼šå°‡ y å¾ 100 æ”¹ç‚º 180ï¼Œå¢åŠ èˆ‡ä¸Šæ–¹ã€Œé“å£‡éˆåŠ›ã€è¡€æ¢çš„è¦–è¦ºé–“éš”
            const y = 180; 
            ctx.save(); ctx.translate(x, y);
            
            // å¤–æ¡†èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 2;
            ctx.fillRect(-40, -40, 80, 80); ctx.strokeRect(-40, -40, 80, 80);
            
            // æ¨™é¡Œ
            ctx.fillStyle = '#FFF'; ctx.font = '12px Microsoft JhengHei'; ctx.textAlign = 'center'; ctx.fillText("å¤©çœ¼é€š", 0, -50);
            
            // ç¹ªè£½é¬¼æ€ªé è¦½ (èˆ‡ Ghost.draw ä¿æŒä¸€è‡´)
            // ä½¿ç”¨ nextGhostColor
            ctx.shadowColor = nextGhostColor; ctx.shadowBlur = 15;
            
            // --- é è¦½åœ–æ¡ˆåˆ¤æ–· (åŒæ­¥ Ghost.draw é‚è¼¯) ---
            // ç›´æ¥å‘¼å«å…±ç”¨çš„ç¹ªåœ–å‡½å¼ï¼Œç¸®å°åŠå¾‘ä»¥é©æ‡‰æ¡† (radius=15)
            drawGhostAppearance(ctx, nextGhostData.hanzi, nextGhostColor, 15);
            
            // æ¼¢å­— (ä½¿ç”¨é‡‘é»ƒè‰²é¡¯ç¤º)
            ctx.fillStyle = '#FFD700'; ctx.font = 'bold 16px Microsoft JhengHei'; 
            // ä¸‹ç§»åˆ° y=30ï¼Œé¿å…æ“‹ä½è‡‰
            ctx.fillText(nextGhostData.hanzi, 0, 30);
            
            ctx.restore();
        }

        function takeDamage(amount) {
            wallHp -= amount;
            if (wallHp < 0) wallHp = 0;
            if (wallHp === 0) triggerGameOver();
            updateUI();
        }

        async function triggerWin() {
            // é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœéŠæˆ²å·²ç¶“çµæŸï¼Œå°±ä¸å†åŸ·è¡Œ (é¿å…é‡è¤‡ä¸Šå‚³æˆç¸¾)
            if (gameState === 'GAMEOVER') return;
            
            gameState = 'GAMEOVER';
            document.getElementById('leftControls').style.display = 'none';
            // å‹åˆ©æ™‚åœæ­¢ BGM
            if(bgmGainNode) bgmGainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            playRoosterCrow();
            const endTitle = document.getElementById('endTitle');
            endTitle.innerText = "æ—­æ—¥æ±æ˜‡ï¼Œé›å•¼å ±å–œï¼";
            endTitle.style.color = "#FFD700";
            endTitle.style.textShadow = "0 0 20px #FF4500";
            
            // Firebase Upload
            if (window.saveScoreToFirebase) window.saveScoreToFirebase(playerName, score);
            
            showResult(true);
        }

        async function triggerGameOver() {
            // é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœéŠæˆ²å·²ç¶“çµæŸï¼Œå°±ä¸å†åŸ·è¡Œ (é¿å…é‡è¤‡ä¸Šå‚³æˆç¸¾)
            if (gameState === 'GAMEOVER') return;

            gameState = 'GAMEOVER';
            document.getElementById('leftControls').style.display = 'none';
            // å¤±æ•—æ™‚åœæ­¢ BGM
            if(bgmGainNode) bgmGainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            const endTitle = document.getElementById('endTitle');
            endTitle.innerText = "é“å£‡å¤±å®ˆï¼";
            endTitle.style.color = "#ff3333";
            endTitle.style.textShadow = "none";
            
            // Firebase Upload
            if (window.saveScoreToFirebase) window.saveScoreToFirebase(playerName, score);
            
            showResult(false);
        }

        async function showResult(isWin) {
            document.getElementById('finalScore').innerText = score;
            
            // éšå±¤ç³»çµ± 7éšå±¤ (0~15000+)
            let rank = "èœé³¥é“ç«¥";
            let color = "#aaa"; // ç°
            
            if (score >= 15000) { 
                rank = "ä¸‰ç•Œå¤§å¤©å¸«"; 
                color = "#FFD700"; // é‡‘
            } else if (score >= 12000) { 
                rank = "ä¸€ä»£å®—å¸«"; 
                color = "#E91E63"; // ç²‰ç´…
            } else if (score >= 9000) { 
                rank = "é™é­”çœŸäºº"; 
                color = "#9C27B0"; // ç´«
            } else if (score >= 6000) { 
                rank = "é«˜åŠŸæ³•å¸«"; 
                color = "#4FC3F7"; // è—
            } else if (score >= 3000) {
                rank = "æŒåŠæ³•å¸«";
                color = "#00E676"; // ç¶ 
            } else if (score >= 1000) {
                rank = "å…¥é–€é“å£«";
                color = "#FF9800"; // æ©˜
            }
            // else < 1000 èœé³¥é“ç«¥ (ç°)

            const rankEl = document.getElementById('rankDisplay');
            // ä¿®æ”¹ï¼šåŠ å…¥ç©å®¶åç¨±
            rankEl.innerText = `${playerName} ${rank}`; 
            rankEl.style.borderColor = color; 
            rankEl.style.color = color; 
            rankEl.style.boxShadow = `0 0 10px ${color}`;
            
            document.getElementById('screen-gameover').classList.remove('hidden');
            gameInput.blur();

            // è‡ªå‹•è¼‰å…¥æ’è¡Œæ¦œ
            openLeaderboard();

            await callGeminiAnalysis(score, rank, isWin);
        }

        // æ’è¡Œæ¦œæ§åˆ¶
        function openLeaderboard() {
            document.getElementById('screen-leaderboard').classList.remove('hidden');
            if (window.fetchLeaderboard) window.fetchLeaderboard();
        }
        function closeLeaderboard() {
            document.getElementById('screen-leaderboard').classList.add('hidden');
        }

        async function callGeminiAnalysis(score, rankTitle, isWin) {
            const contentDiv = document.getElementById('geminiAnalysisContent');
            contentDiv.innerText = "æ­£åœ¨æ­è«‹å¼µå¤©å¸«é™ç¤º... (AI åˆ†æä¸­)";
            const mistakeText = mistakes.length > 0 ? mistakes.join(', ') : "ç„¡ (åŠŸå¾·åœ“æ»¿)";
            const statusText = isWin ? "ç©å®¶æˆåŠŸæ’åˆ°å¤©äº®ï¼Œé‡‘é›å ±å–œã€‚" : "é“å£‡è¢«æ”»ç ´ï¼Œé™å¦–å¤±æ•—ã€‚";
            const prompt = `ä½ æ˜¯é“æ•™è‡³å°Šã€Œå¼µå¤©å¸«ã€ã€‚ç©å®¶å‰›å®Œæˆä¸€å ´å°èªé™å¦–é™¤é­”çš„è©¦ç…‰ã€‚
            æˆ°æ³ï¼š${statusText}
            åˆ†æ•¸ï¼š${score}ã€‚
            ç²å¾—æ³•è™Ÿï¼š${rankTitle}ã€‚
            æœªè¶…æ¸¡çš„è©å½™ï¼š${mistakeText}ã€‚
            è«‹ç”¨ã€Œå¼µå¤©å¸«ã€çš„å£å»ï¼ˆå¤é¢¨ã€å¨åš´ã€å……æ»¿é“å®¶æ™ºæ…§ï¼‰ï¼Œé‡å°å¼Ÿå­çš„è¡¨ç¾çµ¦äºˆé–‹ç¤ºèˆ‡é»è©•ã€‚
            å¦‚æœæ˜¯ç²å‹ï¼Œè«‹çµ¦äºˆé«˜åº¦è®šè³ï¼›å¦‚æœæ˜¯å¤±æ•—ï¼Œè«‹çµ¦äºˆé¼“å‹µã€‚
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸¦åŒ…å«ä¸€é»å°èªæ‹¼éŸ³çš„å­¸ç¿’å»ºè­°ã€‚å­—æ•¸åœ¨ 60 å­—ä»¥å…§ã€‚`;
            try {
                // ä¿®æ”¹ï¼šä½¿ç”¨ç›®å‰ç©©å®šæ”¯æ´çš„ gemini-1.5-flash æ¨¡å‹ï¼Œç¢ºä¿é‡‘é‘°èƒ½æ­£å¸¸é‹ä½œ
                console.log("ç›®å‰çš„ API KEY:", apiKey);
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    contentDiv.innerText = data.candidates[0].content.parts[0].text;
                } else {
                    console.error("API response error:", data);
                    contentDiv.innerText = "é›²æ·±ä¸çŸ¥è™•ï¼Œå¤©å¸«é–‰é—œä¸­... ";
                }
            } catch (error) {
                console.error(error);
                contentDiv.innerText = "æ³•å£‡è¨Šè™Ÿä¸­æ–· (API Error)";
            }
        }

        function useItem(type) {
            if (isPaused || items[type].count <= 0) return; 
            let used = false;
            // æ‰¾å‡ºæ‰€æœ‰å­˜æ´»ä¸”æœªè¢«é–å®šçš„é¬¼æ€ª
            const candidates = ghosts.filter(g => g.hp > 0 && !g.isTargetedByItem);
            
            if (type === 'talisman') {
                if (candidates.length > 0) {
                    playTalismanSound(); // æ–°å¢éŸ³æ•ˆ
                    // æ‰¾å‡ºæœ€è¿‘çš„é¬¼
                    let target = candidates.reduce((prev, curr) => (prev.x < curr.x) ? prev : curr);
                    target.isTargetedByItem = true; // æ¨™è¨˜ç‚ºå·²é–å®š
                    taoist.shootHoming(target, 'talisman'); // ç™¼å°„å°å½ˆ
                    used = true;
                }
            } else if (type === 'sword') {
                if(candidates.length > 0) {
                    playSwordSound(); // æ–°å¢éŸ³æ•ˆ
                    candidates.sort((a,b)=>a.x-b.x); // æŒ‰è·é›¢æ’åº
                    let count = Math.ceil(candidates.length / 2);
                    for(let i=0; i<count; i++) {
                        candidates[i].isTargetedByItem = true;
                        taoist.shootHoming(candidates[i], 'sword');
                    }
                    used = true;
                }
            } else if (type === 'bell') {
                if(candidates.length > 0) {
                    playBellSound(); // æ–°å¢éŸ³æ•ˆ
                    // å¸å…¬éˆƒå…¨å ´æ”»æ“Š
                    candidates.forEach(g => {
                        g.isTargetedByItem = true;
                        taoist.shootHoming(g, 'bell');
                    }); 
                    used = true;
                }
            }
            if (used) { items[type].count--; updateUI(); gameInput.focus(); }
        }

        function killGhost(ghost, attackType = 'normal') {
            if (ghost.hp > 0 && !ghost.alreadyDead) {
                ghost.alreadyDead = true; 
                // è‹¥æ˜¯ä¸€èˆ¬æ”»æ“Šï¼Œç™¼å°„æ™®é€šç¬¦å’’ï¼›è‹¥æ˜¯é“å…·ï¼ŒæŠ•å°„ç‰©å·²åœ¨é£›è¡Œä¸­ï¼Œæ­¤è™•åƒ…è™•ç†æ­»äº¡æ•ˆæœ
                if (attackType === 'normal') {
                    // ä¿®æ­£ï¼šç§»é™¤ç›´æ¥å‘¼å« shootAtï¼Œå› ç‚ºå·²ç¶“åœ¨ checkInputMatch ä¸­ç™¼å°„äº†è¿½è¹¤å½ˆ
                    // é€™è£¡åªè² è²¬çµç®—
                    killCount++; // ä¸€èˆ¬æ“Šæ®ºæ‰ç®— Combo
                    checkRewards();
                }
                
                createParticles(ghost.x, ghost.y, ghost.bodyColor, 15);
                score += ghost.score;
                ghost.hp = 0; 
                updateUI();
            }
        }
        
        function checkRewards() {
            if (killCount % items.bell.threshold === 0) {
                items.bell.count++;
                if (difficulty !== 'A') return;
            }
            if (difficulty === 'A') {
                if (killCount % items.sword.threshold === 0) items.sword.count++;
                if (killCount % items.talisman.threshold === 0) items.talisman.count++;
            }
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
        }

        function animate() {
            if (gameState !== 'PLAYING' && gameState !== 'GAMEOVER') return; 
            if (gameState === 'GAMEOVER') return;
            if (isPaused) { requestAnimationFrame(animate); return; }

            requestAnimationFrame(animate);
            frames++;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const progress = timeElapsed / GAME_DURATION_SEC;
            
            drawSky(ctx, canvas.width, canvas.height, progress);
            // ç¹ªè£½é“å£‡ (ä½¿ç”¨ ALTAR_X)
            drawAltar(ctx, ALTAR_X, canvas.height);
            drawRooster(ctx, canvas.width - 50, canvas.height - 50, false); 

            if (frames % 60 === 0) {
                timeElapsed++;
                updateUI();
                if (timeElapsed >= GAME_DURATION_SEC) {
                    triggerWin();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawSky(ctx, canvas.width, canvas.height, 1.0);
                    drawAltar(ctx, ALTAR_X, canvas.height); 
                    drawRooster(ctx, canvas.width - 50, canvas.height - 50, true); 
                    taoist.draw(); 
                    return; 
                }
            }

            spawnGhost();
            drawNextGhostPreview();
            taoist.update(); taoist.draw();

            for (let i = ghosts.length - 1; i >= 0; i--) {
                let g = ghosts[i]; g.update(); g.draw();
                if (g.hp <= 0) ghosts.splice(i, 1);
            }
            for (let i = projectiles.length - 1; i >= 0; i--) {
                let p = projectiles[i]; p.update(); p.draw();
                if (p.markedForDeletion) projectiles.splice(i, 1);
            }
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i]; p.update(); p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        // --- è¼¸å…¥è™•ç† ---
        gameInput.addEventListener('compositionstart', () => { isComposing = true; });
        gameInput.addEventListener('compositionend', (e) => { isComposing = false; updateUI(); });
        gameInput.addEventListener('input', (e) => {
            if (gameState !== 'PLAYING' || isPaused) return;
            if (!isComposing) {
                const val = gameInput.value.toLowerCase().trim();
                const isSimpleAscii = /^[\x00-\x7F]*$/.test(val);
                if (isSimpleAscii && val.length > 0) checkInputMatch(val); 
            }
        });
        gameInput.addEventListener('keydown', (e) => {
            if (gameState !== 'PLAYING' || isPaused) return;
            if (e.key === 'Enter') {
                if (isComposing) return;
                const val = gameInput.value.toLowerCase().trim();
                if (val.length > 0) {
                    const hit = checkInputMatch(val);
                    if (!hit) { gameInput.style.borderColor = "red"; setTimeout(() => gameInput.style.borderColor = "#00FF00", 200); }
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (gameState === 'PLAYING' && !isPaused && e.target.tagName !== 'BUTTON' && !e.target.closest('.item-slot') && e.target.id !== 'soundUpload') {
                gameInput.focus();
            }
        });

        function checkInputMatch(val) {
            let processedVal = processInput(val).normalize('NFC'); 
            let candidates = [];
            ghosts.forEach((g, index) => {
                // ä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦å·²è¢«é–å®š (pendingDeath)ï¼Œé¿å…é‡è¤‡æ“Šæ®º
                if (g.hp > 0 && !g.isTargetedByItem && !g.pendingDeath) {
                    let targetTailo = g.tailo.toLowerCase().normalize('NFC');
                    if (targetTailo === val.normalize('NFC') || targetTailo === processedVal || (g.numeric && g.numeric.includes(val))) {
                        candidates.push({ghost: g, index: index});
                    }
                }
            });
            if (candidates.length > 0) {
                candidates.sort((a, b) => a.ghost.x - b.ghost.x); 
                let target = candidates[0].ghost;
                
                // ä¿®æ­£é‚è¼¯ï¼šæ¨™è¨˜ç‚ºé–å®šï¼Œç™¼å°„è¿½è¹¤å½ˆï¼Œä½†ä¸ç«‹å³æ“Šæ®º
                target.pendingDeath = true;
                taoist.shootHoming(target, 'normal');
                
                gameInput.value = ""; 
                return true; 
            }
            return false; 
        }

        // --- UI äº‹ä»¶ ---
        document.getElementById('titleBtn').addEventListener('click', () => {
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-setup-step1').classList.remove('hidden'); 
        });
        document.getElementById('toInstructionsBtn').addEventListener('click', () => {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (!name) { 
                // ä½¿ç”¨è¦–è¦ºæç¤ºå–ä»£ alert
                nameInput.style.borderColor = "red";
                nameInput.placeholder = "è«‹å‹™å¿…è¼¸å…¥ä»£è™Ÿï¼";
                setTimeout(() => {
                    nameInput.style.borderColor = "#ccc";
                    nameInput.placeholder = "è«‹è¼¸å…¥é“å£«ä»£è™Ÿ/åç¨±";
                }, 2000);
                return; 
            }
            playerName = name;
            document.getElementById('screen-setup-step2').classList.add('hidden');
            document.getElementById('screen-instructions').classList.remove('hidden');
        });
        const diffBtns = document.querySelectorAll('.difficulty-btn');
        diffBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                diffBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected'); difficulty = btn.dataset.diff;
            });
        });
        
        document.getElementById('startGameBtn').addEventListener('click', () => {
            document.getElementById('screen-instructions').classList.add('hidden');
            gameState = 'PLAYING';
            hasStartedGame = true; 
            
            // ç¢ºä¿éŸ³æ¨‚å•Ÿå‹•
            if(bgmEnabled && !audioCtx) {
                initAudio();
            } else if (bgmEnabled && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            initGame();
            animate();
        });
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('screen-gameover').classList.add('hidden');
            gameState = 'PLAYING'; 
            hasStartedGame = true;
            if(bgmEnabled) {
                if(!audioCtx) initAudio();
                if(audioCtx.state === 'suspended') audioCtx.resume();
                if(bgmGainNode) bgmGainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            }
            initGame(); 
            animate();
        });
        document.getElementById('homeBtn').addEventListener('click', () => {
            document.getElementById('screen-gameover').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('hidden');
            document.getElementById('leftControls').style.display = 'none';
            gameState = 'HOME'; isPaused = false;
            quitGame(); 
        });
    </script>
</body>
</html>